{% load core_tags %}

<!-- Page Header -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-4 mb-6">
    <div class="flex items-center gap-3 md:gap-4">
        <a href="{% url 'gradebook:reports' %}?class={{ student.current_class.pk }}"
           hx-get="{% url 'gradebook:reports' %}?class={{ student.current_class.pk }}"
           hx-target="#main-content"
           hx-push-url="true"
           class="btn btn-ghost btn-sm btn-circle flex-shrink-0">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div class="min-w-0">
            <h1 class="text-lg md:text-xl font-bold">Report Card</h1>
            <p class="text-sm text-base-content/60 truncate">
                {{ student.first_name }} {{ student.last_name }} - {{ current_term.name }}
            </p>
        </div>
    </div>
    <div class="flex gap-2 ml-11 md:ml-0">
        <a href="{% url 'gradebook:transcript' student.pk %}"
           hx-get="{% url 'gradebook:transcript' student.pk %}"
           hx-target="#main-content"
           hx-push-url="true"
           class="btn btn-xs md:btn-sm btn-ghost"
           title="View Transcript">
            <i class="fa-solid fa-scroll"></i>
            <span class="hidden sm:inline">Transcript</span>
        </a>
        <a href="{% url 'gradebook:report_card_print' student.pk %}"
           target="_blank"
           class="btn btn-xs md:btn-sm btn-primary"
           title="Print Report Card">
            <i class="fa-solid fa-print"></i>
            <span class="hidden sm:inline">Print</span>
        </a>
    </div>
</div>

<!-- Student Info Card -->
<div class="card bg-base-100 shadow-sm border border-base-200 mb-6">
<div class="card-body p-4">
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div>
        <div class="text-xs text-base-content/60 uppercase">Student</div>
        <div class="font-medium">{{ student.last_name }}, {{ student.first_name }}</div>
    </div>
    <div>
        <div class="text-xs text-base-content/60 uppercase">ID</div>
        <div class="font-medium">{{ student.admission_number }}</div>
    </div>
    <div>
        <div class="text-xs text-base-content/60 uppercase">Class</div>
        <div class="font-medium">{{ student.current_class.name }}</div>
    </div>
    <div>
        <div class="text-xs text-base-content/60 uppercase">Term</div>
        <div class="font-medium">{{ current_term.name }}</div>
    </div>
</div>
</div>
</div>

<!-- Summary Stats -->
{% if term_report %}
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="card bg-primary/10 border border-primary/20">
        <div class="card-body p-3 text-center">
            <div class="text-xs text-base-content/60">Position</div>
            <div class="text-2xl font-bold text-primary">{{ term_report.position }}<span class="text-sm text-base-content/50">/{{ term_report.out_of }}</span></div>
        </div>
    </div>
    <div class="card bg-secondary/10 border border-secondary/20">
        <div class="card-body p-3 text-center">
            <div class="text-xs text-base-content/60">Average</div>
            <div class="text-2xl font-bold text-secondary">{{ term_report.average }}%</div>
        </div>
    </div>
    <div class="card bg-success/10 border border-success/20">
        <div class="card-body p-3 text-center">
            <div class="text-xs text-base-content/60">Passed</div>
            <div class="text-2xl font-bold text-success">{{ term_report.subjects_passed }}</div>
        </div>
    </div>
    <div class="card bg-error/10 border border-error/20">
        <div class="card-body p-3 text-center">
            <div class="text-xs text-base-content/60">Failed</div>
            <div class="text-2xl font-bold text-error">{{ term_report.subjects_failed }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Subject Grades -->
<div class="card bg-base-100 shadow-sm border border-base-200 mb-6">
    <div class="card-body p-3 md:p-4">
        <h2 class="font-bold flex items-center gap-2 mb-3 md:mb-4">
            <i class="fa-solid fa-book text-primary"></i>
            Subject Grades
        </h2>
        <!-- Mobile scroll hint -->
        <div class="md:hidden flex items-center justify-end gap-2 text-xs text-base-content/50 mb-2">
            <i class="fa-solid fa-arrows-left-right"></i>
            <span>Scroll for more</span>
        </div>
        <div class="overflow-x-auto -mx-3 px-3 md:mx-0 md:px-0">
            <table class="table table-xs md:table-sm">
                <thead>
                    <tr class="text-xs uppercase bg-base-200">
                        <th class="sticky left-0 bg-base-200 z-10 min-w-[100px]">Subject</th>
                        {% for cat in categories %}
                        <th class="text-center min-w-[50px]" title="{{ cat.name }} ({{ cat.percentage }}%)">{{ cat.short_name }}</th>
                        {% endfor %}
                        <th class="text-center min-w-[50px]">Total</th>
                        <th class="text-center min-w-[50px]">Grade</th>
                        <th class="text-center min-w-[40px] hidden sm:table-cell">Pos</th>
                        <th class="hidden md:table-cell">Remark</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grade in subject_grades %}
                    <tr class="hover">
                        <td class="font-medium sticky left-0 bg-base-100 z-10 text-sm">
                            <span class="hidden sm:inline">{{ grade.subject.name }}</span>
                            <span class="sm:hidden">{{ grade.subject.short_name|default:grade.subject.name }}</span>
                        </td>
                        {% for cat in categories %}
                        <td class="text-center">
                            {% with score=grade|get_category_score:cat %}
                            {{ score|default:'-' }}
                            {% endwith %}
                        </td>
                        {% endfor %}
                        <td class="text-center font-bold">{{ grade.total_score|default:'-' }}</td>
                        <td class="text-center">
                            {% if grade.grade %}
                            <span class="badge badge-xs md:badge-sm {% if grade.is_passing %}badge-success{% else %}badge-error{% endif %}">
                                {{ grade.grade }}
                            </span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="text-center hidden sm:table-cell">{{ grade.position|default:'-' }}</td>
                        <td class="text-sm text-base-content/60 hidden md:table-cell max-w-[150px] truncate">{{ grade.grade_remark }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ categories|length|add:5 }}" class="text-center py-8 text-base-content/40">
                            No grades calculated yet. Please calculate grades first.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Remarks -->
{% if term_report %}
<div class="card bg-base-100 shadow-sm border border-base-200">
    <div class="card-body p-4">
        <div class="flex items-center justify-between mb-2">
            <h2 class="font-bold flex items-center gap-2">
                <i class="fa-solid fa-comment-dots text-primary"></i>
                Remarks
            </h2>
            <button class="btn btn-ghost btn-xs"
                    hx-get="{% url 'gradebook:report_remarks' student.pk %}"
                    hx-target="#remarks-modal-content"
                    onclick="modal_remarks.showModal()">
                <i class="fa-solid fa-pen-to-square"></i>
                Edit
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
                <label class="label py-1">
                    <span class="label-text text-xs text-base-content/60">Class Teacher's Remark</span>
                </label>
                <div class="p-3 bg-base-200 rounded-lg min-h-16 text-sm">
                    {{ term_report.class_teacher_remark|default:'No remark yet' }}
                </div>
            </div>
            <div class="form-control">
                <label class="label py-1">
                    <span class="label-text text-xs text-base-content/60">Head Teacher's Remark</span>
                </label>
                <div class="p-3 bg-base-200 rounded-lg min-h-16 text-sm">
                    {{ term_report.head_teacher_remark|default:'No remark yet' }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Remarks Edit Modal -->
<dialog id="modal_remarks" class="modal modal-middle">
    <div class="modal-box max-w-lg">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </form>
        <div id="remarks-modal-content">
            <div class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// Close remarks modal on success and refresh page content
document.body.addEventListener('closeModal', function() {
    const modal = document.getElementById('modal_remarks');
    if (modal) modal.close();

    // Refresh the report card page content
    htmx.ajax('GET', '{% url "gradebook:student_report" student.pk %}', {
        target: '#main-content',
        swap: 'innerHTML'
    });
});
</script>
