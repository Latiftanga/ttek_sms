{% load core_tags %}

<div x-data="{
        tab: 'overview',
        init() {
            const hash = window.location.hash.substring(1);
            if (['overview', 'assignments', 'promotions', 'qualifications'].includes(hash)) {
                this.tab = hash;
            }
            this.$watch('tab', val => history.replaceState(null, '', '#' + val));
        }
     }">

    <!-- Profile Card -->
    <div class="card bg-base-100 shadow-sm border border-base-200 mb-4">
        <!-- Accent stripe -->
        <div class="h-1.5 bg-gradient-to-r from-primary via-secondary to-accent rounded-t-xl"></div>

        <div class="card-body p-4 sm:p-6">
            <div class="flex items-start gap-4">
                <!-- Avatar -->
                <div class="avatar shrink-0">
                    <div class="w-16 sm:w-20 rounded-full ring-2 ring-primary ring-offset-base-100 ring-offset-2">
                        {% if teacher.photo %}
                        <img src="{{ teacher.photo.url }}" alt="{{ teacher.full_name }}" class="rounded-full object-cover" loading="lazy" />
                        {% else %}
                        <div class="w-full h-full flex items-center justify-center {{ teacher.gender|yesno:'gender-male,gender-female' }}">
                            <span class="text-xl sm:text-2xl font-bold">{{ teacher.first_name|slice:":1" }}{{ teacher.last_name|slice:":1" }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Info -->
                <div class="flex-1 min-w-0">
                    <div class="flex flex-wrap items-start justify-between gap-2">
                        <div>
                            <h1 class="text-lg sm:text-xl font-bold">{{ teacher.get_title_display }} {{ teacher.full_name }}</h1>
                            <div class="flex flex-wrap items-center gap-1.5 mt-1">
                                <span class="badge badge-ghost badge-sm font-mono">{{ teacher.staff_id }}</span>
                                <span class="badge badge-sm {% if teacher.status == 'active' %}badge-success{% elif teacher.status == 'inactive' %}badge-error{% else %}badge-warning{% endif %}">
                                    {{ teacher.get_status_display }}
                                </span>
                            </div>
                        </div>
                        <a href="{% url 'core:profile_edit' %}"
                           hx-get="{% url 'core:profile_edit' %}"
                           hx-target="#main-content"
                           hx-push-url="true"
                           class="btn btn-primary btn-sm gap-1">
                            <i class="fa-solid fa-pen text-xs"></i>
                            <span class="hidden sm:inline">Edit</span>
                        </a>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm mt-3">
                        <div>
                            <p class="text-[10px] uppercase text-base-content/50 font-medium">Classes</p>
                            <p class="font-bold text-primary">{{ workload.classes_taught }}</p>
                        </div>
                        <div>
                            <p class="text-[10px] uppercase text-base-content/50 font-medium">Subjects</p>
                            <p class="font-bold text-secondary">{{ workload.subjects_taught }}</p>
                        </div>
                        <div>
                            <p class="text-[10px] uppercase text-base-content/50 font-medium">Students</p>
                            <p class="font-bold text-accent">{{ workload.total_students }}</p>
                        </div>
                        <div>
                            <p class="text-[10px] uppercase text-base-content/50 font-medium">Homeroom</p>
                            <p class="font-bold text-info">{{ workload.homeroom_classes }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Info -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-4 pt-3 border-t border-base-200 text-sm">
                <div class="flex items-center gap-2 min-w-0">
                    <div class="w-7 h-7 rounded-full bg-base-200/60 flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-envelope text-base-content/50 text-[10px]"></i>
                    </div>
                    <span class="truncate text-base-content/70">{{ teacher.email|default:request.user.email }}</span>
                </div>
                {% if teacher.phone_number %}
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-full bg-base-200/60 flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-phone text-base-content/50 text-[10px]"></i>
                    </div>
                    <span class="text-base-content/70">{{ teacher.phone_number }}</span>
                </div>
                {% endif %}
                {% if teacher.date_of_birth %}
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-full bg-base-200/60 flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-cake-candles text-base-content/50 text-[10px]"></i>
                    </div>
                    <span class="text-base-content/70">{{ teacher.date_of_birth|date:"M j, Y" }}</span>
                </div>
                {% endif %}
                {% if teacher.employment_date %}
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-full bg-base-200/60 flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-briefcase text-base-content/50 text-[10px]"></i>
                    </div>
                    <span class="text-base-content/70">Since {{ teacher.employment_date|date:"M Y" }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tabbed Content -->
    <div class="card bg-base-100 shadow-sm border border-base-200">

        <!-- Tab Navigation -->
        <div class="border-b border-base-200 px-2 sm:px-4 pt-1">
            <div class="flex overflow-x-auto scrollbar-none -mb-px">
                <button class="flex-1 sm:flex-none px-3 sm:px-5 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap cursor-pointer"
                        :class="tab === 'overview' ? 'border-primary text-primary' : 'border-transparent text-base-content/60 hover:text-base-content'"
                        @click="tab = 'overview'">
                    <i class="fa-regular fa-id-card sm:mr-1.5"></i>
                    <span class="hidden sm:inline">Overview</span>
                </button>
                <button class="flex-1 sm:flex-none px-3 sm:px-5 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap cursor-pointer"
                        :class="tab === 'assignments' ? 'border-primary text-primary' : 'border-transparent text-base-content/60 hover:text-base-content'"
                        @click="tab = 'assignments'">
                    <i class="fa-solid fa-chalkboard-user sm:mr-1.5"></i>
                    <span class="hidden sm:inline">Assignments</span>
                    {% if subject_assignments %}<span class="badge badge-xs badge-ghost ml-1">{{ subject_assignments|length }}</span>{% endif %}
                </button>
                <button class="flex-1 sm:flex-none px-3 sm:px-5 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap cursor-pointer"
                        :class="tab === 'promotions' ? 'border-primary text-primary' : 'border-transparent text-base-content/60 hover:text-base-content'"
                        @click="tab = 'promotions'">
                    <i class="fa-solid fa-ranking-star sm:mr-1.5"></i>
                    <span class="hidden sm:inline">Promotions</span>
                    {% if promotions %}<span class="badge badge-xs badge-ghost ml-1">{{ promotions|length }}</span>{% endif %}
                </button>
                <button class="flex-1 sm:flex-none px-3 sm:px-5 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap cursor-pointer"
                        :class="tab === 'qualifications' ? 'border-primary text-primary' : 'border-transparent text-base-content/60 hover:text-base-content'"
                        @click="tab = 'qualifications'">
                    <i class="fa-solid fa-award sm:mr-1.5"></i>
                    <span class="hidden sm:inline">Qualifications</span>
                    {% if qualifications %}<span class="badge badge-xs badge-ghost ml-1">{{ qualifications|length }}</span>{% endif %}
                </button>
            </div>
        </div>

        <!-- Tab: Overview -->
        <div x-show="tab === 'overview'" x-cloak class="p-4 sm:p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Personal Information -->
                <div>
                    <h3 class="font-bold text-xs uppercase text-base-content/50 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-user text-primary"></i> Personal Information
                    </h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Full Name</p>
                                <p class="font-medium text-sm">{{ teacher.get_title_display }} {{ teacher.full_name }}</p>
                            </div>
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Gender</p>
                                <p class="font-medium text-sm">{{ teacher.get_gender_display }}</p>
                            </div>
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Date of Birth</p>
                                <p class="font-medium text-sm">{{ teacher.date_of_birth|date:"M j, Y"|default:"Not set" }}</p>
                            </div>
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Phone</p>
                                <p class="font-medium text-sm">{{ teacher.phone_number|default:"Not set" }}</p>
                            </div>
                        </div>
                        {% if teacher.address %}
                        <div class="bg-base-200/50 rounded-lg p-3">
                            <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Address</p>
                            <p class="font-medium text-sm">{{ teacher.address }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Employment & Homeroom -->
                <div class="space-y-6">
                    <!-- Employment Details -->
                    <div>
                        <h3 class="font-bold text-xs uppercase text-base-content/50 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-briefcase text-accent"></i> Employment
                        </h3>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-base-200/50 rounded-lg p-3">
                                    <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Staff ID</p>
                                    <p class="font-mono font-medium text-sm">{{ teacher.staff_id }}</p>
                                </div>
                                <div class="bg-base-200/50 rounded-lg p-3">
                                    <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Employed</p>
                                    <p class="font-medium text-sm">{{ teacher.employment_date|date:"M j, Y"|default:"Not set" }}</p>
                                </div>
                            </div>
                            {% if teacher.employment_date %}
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Service Duration</p>
                                <p class="font-medium text-sm">{{ teacher.employment_date|timesince }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Homeroom Classes -->
                    {% if homeroom_classes %}
                    <div>
                        <h3 class="font-bold text-xs uppercase text-base-content/50 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-house-user text-info"></i> Homeroom Classes
                        </h3>
                        <div class="space-y-2">
                            {% for cls in homeroom_classes %}
                            <div class="bg-base-200/50 rounded-lg p-3 flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-info/10 flex items-center justify-center shrink-0">
                                    <span class="text-xs font-bold text-info">{{ cls.name|slice:":3" }}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm">{{ cls.name }}</p>
                                    <p class="text-[10px] text-base-content/50">{{ cls.student_count }} active students</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Account Security -->
                    <div>
                        <h3 class="font-bold text-xs uppercase text-base-content/50 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-shield-halved text-success"></i> Account
                        </h3>
                        <div class="bg-success/5 border border-success/20 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3 min-w-0">
                                    <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center shrink-0">
                                        <i class="fa-solid fa-check text-success"></i>
                                    </div>
                                    <div class="min-w-0">
                                        <p class="font-medium text-sm">Account Active</p>
                                        <p class="text-xs text-base-content/60 truncate">{{ request.user.email }}</p>
                                    </div>
                                </div>
                                <button hx-get="{% url 'accounts:password_change' %}"
                                        hx-target="#password-change-container"
                                        hx-swap="innerHTML"
                                        onclick="document.getElementById('modal_password_change').showModal()"
                                        class="btn btn-ghost btn-sm shrink-0">
                                    <i class="fa-solid fa-key text-xs"></i>
                                    <span class="hidden sm:inline">Password</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Assignments -->
        <div x-show="tab === 'assignments'" x-cloak class="p-4 sm:p-6" style="display: none;">
            <h3 class="font-bold text-xs uppercase text-base-content/50 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-chalkboard-user text-primary"></i> Teaching Assignments
                {% if subject_assignments %}<span class="badge badge-xs badge-ghost">{{ subject_assignments|length }}</span>{% endif %}
            </h3>
            {% if subject_assignments %}
            <div class="space-y-2">
                {% for assignment in subject_assignments %}
                <div class="bg-base-200/50 rounded-lg p-3 flex items-center justify-between hover:bg-base-200/70 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-book text-primary text-sm"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-sm">{{ assignment.subject.name }}</p>
                            <p class="text-[10px] text-base-content/50">{{ assignment.class_assigned.name }}</p>
                        </div>
                    </div>
                    <a href="{% url 'core:enter_scores' assignment.class_assigned.pk assignment.subject.pk %}"
                       hx-get="{% url 'core:enter_scores' assignment.class_assigned.pk assignment.subject.pk %}"
                       hx-target="#main-content"
                       hx-push-url="true"
                       class="btn btn-ghost btn-sm gap-1">
                        <i class="fa-solid fa-pen-to-square text-xs"></i>
                        <span class="hidden sm:inline">Grades</span>
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-10">
                <div class="w-14 h-14 mx-auto mb-3 rounded-full bg-base-200 flex items-center justify-center">
                    <i class="fa-solid fa-clipboard-list text-base-content/30 text-xl"></i>
                </div>
                <p class="text-sm font-medium text-base-content/60">No teaching assignments yet</p>
                <p class="text-xs text-base-content/40 mt-1">Assignments will appear here once configured by admin.</p>
            </div>
            {% endif %}
        </div>

        <!-- Tab: Promotions -->
        <div x-show="tab === 'promotions'" x-cloak class="p-4 sm:p-6" style="display: none;">
            <div id="promotions-content">
                {% include 'teachers/partials/tab_promotions.html' %}
            </div>
        </div>

        <!-- Tab: Qualifications -->
        <div x-show="tab === 'qualifications'" x-cloak class="p-4 sm:p-6" style="display: none;">
            <div id="qualifications-content">
                {% include 'teachers/partials/tab_qualifications.html' %}
            </div>
        </div>
    </div>
</div>

<!-- Promotion/Qualification Modal -->
<dialog id="modal_form" class="modal modal-bottom sm:modal-middle" hx-on::closeModal="this.close()">
    <div class="modal-box max-w-md" id="modal-container"></div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
