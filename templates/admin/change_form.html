{% extends "admin/base.html" %}
{% load i18n admin_urls admin_modify %}

{% block title %}{% if add %}{% blocktrans with name=opts.verbose_name %}Add {{ name }}{% endblocktrans %}{% else %}{{ original|truncatewords:"18" }}{% endif %} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumb_items %}
<li><a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a></li>
<li><a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a></li>
<li>{% if add %}{% trans 'Add' %}{% else %}{{ original|truncatewords:"18" }}{% endif %}</li>
{% endblock %}

{% block content_title %}
<div class="px-6 pt-2 pb-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold">
                {% if add %}
                    {% blocktrans with name=opts.verbose_name %}Add {{ name }}{% endblocktrans %}
                {% else %}
                    {% trans 'Change' %} {{ opts.verbose_name }}
                {% endif %}
            </h1>
            {% if not add %}
            <p class="text-sm text-base-content/60 mt-1">{{ original|truncatewords:"18" }}</p>
            {% endif %}
        </div>
        {% if not add %}
        <div class="flex gap-2">
            {% if has_view_permission and change %}
            <a href="{% url opts|admin_urlname:'history' original.pk|admin_urlquote %}" class="btn btn-ghost btn-sm gap-2">
                <i class="fa-solid fa-clock-rotate-left"></i>
                {% trans 'History' %}
            </a>
            {% endif %}
            {% if has_absolute_url %}
            <a href="{{ absolute_url }}" class="btn btn-ghost btn-sm gap-2" target="_blank">
                <i class="fa-solid fa-external-link"></i>
                {% trans 'View on site' %}
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<form method="post" action="{{ form_url }}" id="{{ opts.model_name }}_form" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {% block form_top %}{% endblock %}

    <div class="grid grid-cols-1 {% if has_related_field_in_list_display %}xl:grid-cols-3{% endif %} gap-6">
        <!-- Main form -->
        <div class="{% if has_related_field_in_list_display %}xl:col-span-2{% endif %} space-y-6">
            {% if is_popup %}<input type="hidden" name="_popup" value="1">{% endif %}
            {% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}
            {% if save_on_top %}{% block submit_buttons_top %}{% submit_row %}{% endblock %}{% endif %}

            {% if errors %}
            <div class="alert alert-error shadow-sm">
                <i class="fa-solid fa-circle-exclamation"></i>
                <div>
                    <h3 class="font-bold">{% trans 'Please correct the errors below.' %}</h3>
                    {{ adminform.form.non_field_errors }}
                </div>
            </div>
            {% endif %}

            {% for fieldset in adminform %}
            <div class="card bg-base-100 shadow-sm border border-base-200 {% if fieldset.classes %}{{ fieldset.classes|join:' ' }}{% endif %}">
                {% if fieldset.name %}
                <div class="card-body p-4 border-b border-base-200">
                    <h2 class="card-title text-lg">{{ fieldset.name }}</h2>
                    {% if fieldset.description %}
                    <p class="text-sm text-base-content/60">{{ fieldset.description }}</p>
                    {% endif %}
                </div>
                {% endif %}
                <div class="card-body p-4 {% if not fieldset.name %}pt-4{% endif %}">
                    {% for line in fieldset %}
                    {% with num_fields=line.fields|length %}
                    <div class="{% if num_fields > 1 %}grid grid-cols-1 md:grid-cols-{{ num_fields }} gap-4{% endif %} {% if not forloop.first %}mt-4{% endif %}">
                        {% for field in line %}
                        <div class="form-control w-full {% if field.field.errors %}has-error{% endif %}">
                            {% if not field.is_checkbox %}
                            <label class="label" for="{{ field.field.id_for_label }}">
                                <span class="label-text font-medium">
                                    {{ field.field.label }}
                                    {% if field.field.field.required %}<span class="text-error">*</span>{% endif %}
                                </span>
                            </label>
                            {% endif %}

                            {% if field.is_readonly %}
                            <div class="px-3 py-2 bg-base-200 rounded-lg text-base-content/80">{{ field.contents }}</div>
                            {% else %}
                            {{ field.field }}
                            {% endif %}

                            {% if field.field.help_text %}
                            <label class="label">
                                <span class="label-text-alt text-base-content/60">{{ field.field.help_text|safe }}</span>
                            </label>
                            {% endif %}

                            {% if field.field.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ field.field.errors|join:", " }}</span>
                            </label>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            {% for inline_admin_formset in inline_admin_formsets %}
            {% include inline_admin_formset.opts.template %}
            {% endfor %}

            {% block submit_buttons_bottom %}{% submit_row %}{% endblock %}
        </div>

        <!-- Sidebar for additional info -->
        {% if has_related_field_in_list_display %}
        <div class="xl:col-span-1">
            {% block object_tools_sidebar %}{% endblock %}
        </div>
        {% endif %}
    </div>

    {% block admin_change_form_document_ready %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add DaisyUI classes to form inputs
            document.querySelectorAll('#{{ opts.model_name }}_form input[type="text"], #{{ opts.model_name }}_form input[type="email"], #{{ opts.model_name }}_form input[type="url"], #{{ opts.model_name }}_form input[type="number"], #{{ opts.model_name }}_form input[type="password"]').forEach(function(input) {
                if (!input.classList.contains('input')) {
                    input.classList.add('input', 'input-bordered', 'w-full');
                }
            });

            document.querySelectorAll('#{{ opts.model_name }}_form select').forEach(function(select) {
                if (!select.classList.contains('select')) {
                    select.classList.add('select', 'select-bordered', 'w-full');
                }
            });

            document.querySelectorAll('#{{ opts.model_name }}_form textarea').forEach(function(textarea) {
                if (!textarea.classList.contains('textarea')) {
                    textarea.classList.add('textarea', 'textarea-bordered', 'w-full');
                }
            });

            document.querySelectorAll('#{{ opts.model_name }}_form input[type="checkbox"]').forEach(function(checkbox) {
                if (!checkbox.classList.contains('checkbox')) {
                    checkbox.classList.add('checkbox', 'checkbox-primary');
                }
            });

            document.querySelectorAll('#{{ opts.model_name }}_form input[type="file"]').forEach(function(fileInput) {
                if (!fileInput.classList.contains('file-input')) {
                    fileInput.classList.add('file-input', 'file-input-bordered', 'w-full');
                }
            });
        });
    </script>
    {% endblock %}
</form>
{% endblock %}
