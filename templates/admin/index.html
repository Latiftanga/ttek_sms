{% extends "admin/base.html" %}
{% load humanize i18n core_tags %}

{% block title %}{{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block content_title %}
<div class="px-6 pt-4 pb-2">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">{{ title|default:_("Dashboard") }}</h1>
            <p class="text-sm text-base-content/60 mt-1">{% now "l, F j, Y" %}</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'admin:schools_school_add' %}" class="btn btn-primary btn-sm gap-2">
                <i class="fa-solid fa-plus"></i>
                {% trans 'Add School' %}
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
{% get_admin_stats as stats %}

<div class="space-y-6">
    <!-- Stats Row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        {% if stats.is_public %}
            <!-- Schools stat -->
            <div class="card bg-gradient-to-br from-primary/10 to-primary/5 border-0 shadow-sm hover:shadow-md transition-shadow">
                <div class="card-body p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide">{% trans 'Total Schools' %}</p>
                            <p class="text-3xl font-bold mt-1">{{ stats.schools|default:"0" }}</p>
                            <p class="text-xs text-base-content/50 mt-1">
                                <span class="text-success">{{ stats.active_schools }} {% trans 'active' %}</span> Â· <span class="text-error">{{ stats.inactive_schools }} {% trans 'inactive' %}</span>
                            </p>
                        </div>
                        <div class="w-14 h-14 rounded-2xl bg-primary/20 flex items-center justify-center">
                            <i class="fa-solid fa-school text-2xl text-primary"></i>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-primary/10">
                        <a href="{% url 'admin:schools_school_changelist' %}" class="text-xs text-primary hover:underline inline-flex items-center gap-1">
                            {% trans 'View all' %} <i class="fa-solid fa-arrow-right text-[10px]"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Users stat -->
            <div class="card bg-gradient-to-br from-secondary/10 to-secondary/5 border-0 shadow-sm hover:shadow-md transition-shadow">
                <div class="card-body p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide">{% trans 'Users' %}</p>
                            <p class="text-3xl font-bold mt-1">{{ stats.users|default:"0" }}</p>
                        </div>
                        <div class="w-14 h-14 rounded-2xl bg-secondary/20 flex items-center justify-center">
                            <i class="fa-solid fa-users text-2xl text-secondary"></i>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-secondary/10">
                        <a href="{% url 'admin:accounts_user_changelist' %}" class="text-xs text-secondary hover:underline inline-flex items-center gap-1">
                            {% trans 'View all' %} <i class="fa-solid fa-arrow-right text-[10px]"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Regions stat -->
            <div class="card bg-gradient-to-br from-accent/10 to-accent/5 border-0 shadow-sm hover:shadow-md transition-shadow">
                <div class="card-body p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide">{% trans 'Regions' %}</p>
                            <p class="text-3xl font-bold mt-1">{{ stats.regions|default:"0" }}</p>
                        </div>
                        <div class="w-14 h-14 rounded-2xl bg-accent/20 flex items-center justify-center">
                            <i class="fa-solid fa-map-location-dot text-2xl text-accent"></i>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-accent/10">
                        <a href="{% url 'admin:schools_region_changelist' %}" class="text-xs text-accent hover:underline inline-flex items-center gap-1">
                            {% trans 'View all' %} <i class="fa-solid fa-arrow-right text-[10px]"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Districts stat -->
            <div class="card bg-gradient-to-br from-success/10 to-success/5 border-0 shadow-sm hover:shadow-md transition-shadow">
                <div class="card-body p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide">{% trans 'Districts' %}</p>
                            <p class="text-3xl font-bold mt-1">{{ stats.districts|default:"0" }}</p>
                        </div>
                        <div class="w-14 h-14 rounded-2xl bg-success/20 flex items-center justify-center">
                            <i class="fa-solid fa-location-dot text-2xl text-success"></i>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-success/10">
                        <a href="{% url 'admin:schools_district_changelist' %}" class="text-xs text-success hover:underline inline-flex items-center gap-1">
                            {% trans 'View all' %} <i class="fa-solid fa-arrow-right text-[10px]"></i>
                        </a>
                    </div>
                </div>
            </div>

        {% else %}
            <!-- Tenant / School Admin Stats -->
            <div class="card bg-gradient-to-br from-primary/10 to-primary/5 border-0 shadow-sm hover:shadow-md transition-shadow">
                <div class="card-body p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide">{% trans 'Students' %}</p>
                            <p class="text-3xl font-bold mt-1">{{ stats.students|default:"0" }}</p>
                        </div>
                        <div class="w-14 h-14 rounded-2xl bg-primary/20 flex items-center justify-center">
                            <i class="fa-solid fa-user-graduate text-2xl text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-gradient-to-br from-info/10 to-info/5 border-0 shadow-sm hover:shadow-md transition-shadow">
                <div class="card-body p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide">{% trans 'Teachers' %}</p>
                            <p class="text-3xl font-bold mt-1">{{ stats.teachers|default:"0" }}</p>
                        </div>
                        <div class="w-14 h-14 rounded-2xl bg-info/20 flex items-center justify-center">
                            <i class="fa-solid fa-chalkboard-user text-2xl text-info"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-gradient-to-br from-secondary/10 to-secondary/5 border-0 shadow-sm hover:shadow-md transition-shadow">
                <div class="card-body p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide">{% trans 'Classes' %}</p>
                            <p class="text-3xl font-bold mt-1">{{ stats.classes|default:"0" }}</p>
                        </div>
                        <div class="w-14 h-14 rounded-2xl bg-secondary/20 flex items-center justify-center">
                            <i class="fa-solid fa-chalkboard text-2xl text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    {% if stats.is_public %}
    <!-- School Insights Section -->
    <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-0">
            <div class="p-4 border-b border-base-200">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie text-base-content/40"></i>
                    {% trans 'School Insights' %}
                </h3>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-0 sm:gap-0 divide-y sm:divide-y-0 sm:divide-x divide-base-200">
                <!-- Education System Breakdown -->
                <div class="p-5">
                    <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide mb-3">{% trans 'Education System' %}</p>
                    <div class="flex flex-wrap gap-2">
                        <span class="badge badge-primary badge-lg gap-1.5">
                            <i class="fa-solid fa-book-open text-xs"></i>
                            {% trans 'Basic' %}: {{ stats.basic_schools }}
                        </span>
                        <span class="badge badge-secondary badge-lg gap-1.5">
                            <i class="fa-solid fa-graduation-cap text-xs"></i>
                            {% trans 'SHS' %}: {{ stats.shs_schools }}
                        </span>
                    </div>
                </div>

                <!-- Recent Onboarding -->
                <div class="p-5">
                    <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide mb-3">{% trans 'Recent Onboarding' %}</p>
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-info/15 flex items-center justify-center">
                            <span class="text-xl font-bold text-info">{{ stats.recent_schools }}</span>
                        </div>
                        <p class="text-sm text-base-content/70">{% trans 'schools added in the last 30 days' %}</p>
                    </div>
                </div>

                <!-- Active vs Inactive -->
                <div class="p-5">
                    <p class="text-xs font-medium text-base-content/60 uppercase tracking-wide mb-3">{% trans 'School Status' %}</p>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-sm flex items-center gap-2">
                                <span class="w-2.5 h-2.5 rounded-full bg-success"></span>
                                {% trans 'Active' %}
                            </span>
                            <span class="font-semibold">{{ stats.active_schools }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm flex items-center gap-2">
                                <span class="w-2.5 h-2.5 rounded-full bg-error"></span>
                                {% trans 'Inactive' %}
                            </span>
                            <span class="font-semibold">{{ stats.inactive_schools }}</span>
                        </div>
                        {% if stats.schools %}
                        <progress class="progress progress-success w-full h-2" value="{{ stats.active_schools }}" max="{{ stats.schools }}"></progress>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content (App List) -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-sm border border-base-200">
                <div class="card-body p-0">
                    <div class="p-4 border-b border-base-200">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa-solid fa-grip text-base-content/40"></i>
                            {% trans 'Applications' %}
                        </h3>
                    </div>

                    {% if app_list %}
                    <div class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for app in app_list %}
                            <div class="rounded-xl border border-base-200 hover:border-primary/30 transition-colors overflow-hidden">
                                <div class="bg-base-200/50 px-4 py-3 border-b border-base-200">
                                    <h4 class="font-semibold flex items-center gap-2">
                                        {% if 'Auth' in app.name or 'Account' in app.name %}
                                            <span class="w-8 h-8 rounded-lg bg-warning/20 flex items-center justify-center"><i class="fa-solid fa-shield-halved text-warning text-sm"></i></span>
                                        {% elif 'School' in app.name %}
                                            <span class="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center"><i class="fa-solid fa-school text-primary text-sm"></i></span>
                                        {% elif 'Academic' in app.name %}
                                            <span class="w-8 h-8 rounded-lg bg-info/20 flex items-center justify-center"><i class="fa-solid fa-graduation-cap text-info text-sm"></i></span>
                                        {% elif 'Student' in app.name %}
                                            <span class="w-8 h-8 rounded-lg bg-success/20 flex items-center justify-center"><i class="fa-solid fa-user-graduate text-success text-sm"></i></span>
                                        {% elif 'Finance' in app.name %}
                                            <span class="w-8 h-8 rounded-lg bg-secondary/20 flex items-center justify-center"><i class="fa-solid fa-coins text-secondary text-sm"></i></span>
                                        {% elif 'Celery' in app.name or 'Task' in app.name %}
                                            <span class="w-8 h-8 rounded-lg bg-warning/20 flex items-center justify-center"><i class="fa-solid fa-clock text-warning text-sm"></i></span>
                                        {% else %}
                                            <span class="w-8 h-8 rounded-lg bg-base-300 flex items-center justify-center"><i class="fa-solid fa-folder text-base-content/50 text-sm"></i></span>
                                        {% endif %}
                                        <a href="{{ app.app_url }}" class="hover:text-primary transition-colors">{{ app.name }}</a>
                                    </h4>
                                </div>
                                <div class="divide-y divide-base-200">
                                    {% for model in app.models %}
                                    <div class="px-4 py-2.5 flex items-center justify-between hover:bg-base-200/30 transition-colors">
                                        {% if model.admin_url %}
                                            <a href="{{ model.admin_url }}" class="text-sm hover:text-primary transition-colors">{{ model.name }}</a>
                                        {% else %}
                                            <span class="text-sm opacity-50">{{ model.name }}</span>
                                        {% endif %}
                                        {% if model.add_url %}
                                        <a href="{{ model.add_url }}" class="btn btn-ghost btn-xs btn-circle text-success hover:bg-success/10" title="{% trans 'Add' %}">
                                            <i class="fa-solid fa-plus text-xs"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="p-8 text-center">
                        <div class="w-16 h-16 rounded-full bg-base-200 flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-lock text-2xl text-base-content/30"></i>
                        </div>
                        <p class="text-base-content/60">{% trans "You don't have permission to view or edit anything." %}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar (Recent Actions) -->
        <div class="lg:col-span-1">
            <div class="card bg-base-100 shadow-sm border border-base-200">
                <div class="card-body p-0">
                    <div class="p-4 border-b border-base-200">
                        <h3 class="font-bold flex items-center gap-2">
                            <i class="fa-solid fa-clock-rotate-left text-base-content/40"></i>
                            {% trans 'Recent Actions' %}
                        </h3>
                    </div>

                    <div class="overflow-y-auto max-h-[500px]">
                        {% load log %}
                        {% get_admin_log 10 as admin_log for_user user %}
                        {% if admin_log %}
                        <div class="divide-y divide-base-200">
                            {% for entry in admin_log %}
                            <a href="{% if entry.get_admin_url %}{{ entry.get_admin_url }}{% else %}#{% endif %}" class="block px-4 py-3 hover:bg-base-200/50 transition-colors">
                                <div class="flex items-start gap-3">
                                    <div class="mt-0.5">
                                        {% if entry.is_addition %}
                                            <span class="w-6 h-6 rounded-full bg-success/20 flex items-center justify-center">
                                                <i class="fa-solid fa-plus text-success text-[10px]"></i>
                                            </span>
                                        {% elif entry.is_change %}
                                            <span class="w-6 h-6 rounded-full bg-warning/20 flex items-center justify-center">
                                                <i class="fa-solid fa-pen text-warning text-[10px]"></i>
                                            </span>
                                        {% elif entry.is_deletion %}
                                            <span class="w-6 h-6 rounded-full bg-error/20 flex items-center justify-center">
                                                <i class="fa-solid fa-trash text-error text-[10px]"></i>
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium truncate">{{ entry.object_repr }}</p>
                                        <p class="text-xs text-base-content/50 mt-0.5">{{ entry.content_type|capfirst }}</p>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="p-8 text-center">
                            <div class="w-12 h-12 rounded-full bg-base-200 flex items-center justify-center mx-auto mb-3">
                                <i class="fa-solid fa-inbox text-base-content/30"></i>
                            </div>
                            <p class="text-sm text-base-content/50">{% trans 'No recent actions' %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
