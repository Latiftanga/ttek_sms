{% load core_tags %}

<style>
.touch-action-manipulation {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}
</style>

<div class="flex justify-between items-center mb-4 sticky top-0 bg-base-100 z-10 pb-2 border-b border-base-200">
    <div>
        <h3 class="text-xl font-bold">{% if is_edit %}Edit Attendance{% else %}Mark Attendance{% endif %}</h3>
        {% if is_lesson and subject %}
        <p class="text-sm font-medium text-primary">{{ subject.name }} - {{ period.name }}</p>
        {% endif %}
        <p class="text-xs text-base-content/60">{{ date|date:"l, F jS Y" }}</p>
    </div>
    <div class="flex flex-col items-end gap-1">
        <div class="badge badge-primary">{{ student_list|length }} Students</div>
        {% if is_lesson %}
        <div class="badge badge-secondary badge-sm">Per-Lesson</div>
        {% endif %}
    </div>
</div>

<!-- Progress Indicator -->
<div class="mb-4 p-3 bg-base-200/50 rounded-lg">
    <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium">Progress</span>
        <span class="text-sm font-bold" id="progress-text">
            <span class="text-success" id="present-count">0</span> P /
            <span class="text-warning" id="late-count">0</span> L /
            <span class="text-error" id="absent-count">0</span> A
        </span>
    </div>
    <div class="flex gap-0.5 h-2 rounded-full overflow-hidden bg-base-300">
        <div class="bg-success transition-all duration-300" id="progress-present" style="width: 0%"></div>
        <div class="bg-warning transition-all duration-300" id="progress-late" style="width: 0%"></div>
        <div class="bg-error transition-all duration-300" id="progress-absent" style="width: 0%"></div>
    </div>
</div>

<!-- Primary Action: Mark All Present -->
<button type="button" onclick="markAll('P')" class="btn btn-success btn-lg w-full gap-2 text-lg font-bold shadow-md mb-3 touch-action-manipulation">
    <i class="fa-solid fa-check-double"></i>
    Mark All Present
</button>

<!-- Secondary Bulk Actions -->
<div class="flex items-center justify-between mb-4 p-2 bg-base-200/50 rounded-lg">
    <span class="text-xs font-medium text-base-content/60">Or mark all:</span>
    <div class="flex gap-2">
        <button type="button" onclick="markAll('L')" class="btn btn-xs btn-warning btn-outline gap-1 touch-action-manipulation">
            <i class="fa-solid fa-clock"></i> Late
        </button>
        <button type="button" onclick="markAll('A')" class="btn btn-xs btn-error btn-outline gap-1 touch-action-manipulation">
            <i class="fa-solid fa-xmark"></i> Absent
        </button>
    </div>
</div>

<form method="post" id="attendance-form"
      {% if is_lesson and timetable_entry_id %}
      action="{% url 'academics:take_lesson_attendance' timetable_entry_id %}"
      hx-post="{% url 'academics:take_lesson_attendance' timetable_entry_id %}"
      {% elif is_edit %}
      action="{% url 'academics:class_attendance_edit' class.pk session.pk %}"
      hx-post="{% url 'academics:class_attendance_edit' class.pk session.pk %}"
      {% else %}
      action="{% url 'academics:class_attendance_take' class.pk %}"
      hx-post="{% url 'academics:class_attendance_take' class.pk %}"
      {% endif %}
      hx-target="body"
      hx-swap="beforeend">
    {% csrf_token %}

    <div class="h-[50vh] overflow-y-auto pr-1 space-y-2">
        {% for item in student_list %}
        <div class="flex items-center justify-between p-3 border border-base-200 rounded-lg hover:bg-base-200/30 gap-3 student-row transition-colors {% if item.status == 'P' %}bg-success/10{% elif item.status == 'A' %}bg-error/10{% elif item.status == 'L' %}bg-warning/10{% endif %}">
            <div class="flex items-center gap-3 flex-1 min-w-0">
                <div class="avatar placeholder shrink-0">
                    <div class="w-12 h-12 rounded-full bg-base-300 flex items-center justify-center">
                        <span class="text-base font-bold">{{ item.obj.first_name|slice:":1" }}{{ item.obj.last_name|slice:":1" }}</span>
                    </div>
                </div>
                <div class="min-w-0">
                    <div class="font-semibold text-base truncate">{{ item.obj.full_name }}</div>
                    <div class="text-xs text-base-content/50 font-mono">{{ item.obj.admission_number }}</div>
                </div>
            </div>

            <!-- Extra Large Touch Targets with Labels -->
            <div class="flex items-center gap-1.5 shrink-0">
                <label class="touch-action-manipulation">
                    <input type="radio" name="status_{{ item.obj.id }}" value="P" class="peer hidden" {% if item.status == 'P' %}checked{% endif %} />
                    <span class="flex flex-col items-center justify-center w-14 h-14 rounded-xl cursor-pointer border-2 border-base-300 bg-base-200 text-base-content/60 peer-checked:bg-success peer-checked:text-success-content peer-checked:border-success peer-checked:shadow-md transition-all active:scale-95">
                        <i class="fa-solid fa-check text-xl"></i>
                        <span class="text-[10px] font-bold mt-0.5">P</span>
                    </span>
                </label>
                <label class="touch-action-manipulation">
                    <input type="radio" name="status_{{ item.obj.id }}" value="L" class="peer hidden" {% if item.status == 'L' %}checked{% endif %} />
                    <span class="flex flex-col items-center justify-center w-14 h-14 rounded-xl cursor-pointer border-2 border-base-300 bg-base-200 text-base-content/60 peer-checked:bg-warning peer-checked:text-warning-content peer-checked:border-warning peer-checked:shadow-md transition-all active:scale-95">
                        <i class="fa-solid fa-clock text-xl"></i>
                        <span class="text-[10px] font-bold mt-0.5">L</span>
                    </span>
                </label>
                <label class="touch-action-manipulation">
                    <input type="radio" name="status_{{ item.obj.id }}" value="A" class="peer hidden" {% if item.status == 'A' %}checked{% endif %} />
                    <span class="flex flex-col items-center justify-center w-14 h-14 rounded-xl cursor-pointer border-2 border-base-300 bg-base-200 text-base-content/60 peer-checked:bg-error peer-checked:text-error-content peer-checked:border-error peer-checked:shadow-md transition-all active:scale-95">
                        <i class="fa-solid fa-xmark text-xl"></i>
                        <span class="text-[10px] font-bold mt-0.5">A</span>
                    </span>
                </label>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="modal-action border-t border-base-200 pt-4 mt-4 gap-3">
        <button type="button" class="btn min-h-[48px] touch-action-manipulation" onclick="var d=this.closest('dialog'); if(d) d.close(); else history.back();">
            Cancel
        </button>
        <button type="submit" class="btn btn-primary flex-1 min-h-[48px] gap-2 text-lg font-bold shadow-md touch-action-manipulation">
            <i class="fa-solid fa-cloud-arrow-up"></i>
            Save Attendance
        </button>
    </div>
</form>

<script>
const totalStudents = {{ student_list|length }};

function updateProgress() {
    const form = document.getElementById('attendance-form');
    let present = 0, late = 0, absent = 0;

    form.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        if (radio.value === 'P') present++;
        else if (radio.value === 'L') late++;
        else if (radio.value === 'A') absent++;
    });

    // Update counts
    document.getElementById('present-count').textContent = present;
    document.getElementById('late-count').textContent = late;
    document.getElementById('absent-count').textContent = absent;

    // Update progress bars
    const presentPct = (present / totalStudents) * 100;
    const latePct = (late / totalStudents) * 100;
    const absentPct = (absent / totalStudents) * 100;

    document.getElementById('progress-present').style.width = presentPct + '%';
    document.getElementById('progress-late').style.width = latePct + '%';
    document.getElementById('progress-absent').style.width = absentPct + '%';
}

function updateRowBackground(radio) {
    const row = radio.closest('.student-row');
    if (!row) return;

    row.classList.remove('bg-success/10', 'bg-warning/10', 'bg-error/10');
    if (radio.value === 'P') row.classList.add('bg-success/10');
    else if (radio.value === 'L') row.classList.add('bg-warning/10');
    else if (radio.value === 'A') row.classList.add('bg-error/10');
}

function markAll(status) {
    const form = document.getElementById('attendance-form');
    const radios = form.querySelectorAll(`input[type="radio"][value="${status}"]`);
    radios.forEach(radio => {
        radio.checked = true;
        updateRowBackground(radio);
    });

    // Update progress
    updateProgress();

    // Haptic feedback if available
    if (navigator.vibrate) {
        navigator.vibrate(50);
    }
}

// Add event listeners to all radio buttons
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('attendance-form');
    form.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateRowBackground(this);
            updateProgress();
            // Light haptic feedback
            if (navigator.vibrate) navigator.vibrate(20);
        });
    });

    // Initialize progress
    updateProgress();
});
</script>