{% load core_tags %}
<div class="flex justify-between items-center mb-4 sticky top-0 bg-base-100 z-10 pb-2 border-b border-base-200">
    <div>
        <h3 class="text-xl font-bold">{% if is_edit %}Edit Attendance{% else %}Mark Attendance{% endif %}</h3>
        {% if is_lesson and subject %}
        <p class="text-sm font-medium text-primary">{{ subject.name }} - {{ period.name }}</p>
        {% endif %}
        <p class="text-xs text-base-content/60">{{ date|date:"l, F jS Y" }}</p>
    </div>
    <div class="flex flex-col items-end gap-1">
        <div class="badge badge-primary">{{ student_list|length }} Students</div>
        {% if is_lesson %}
        <div class="badge badge-secondary badge-sm">Per-Lesson</div>
        {% endif %}
    </div>
</div>

<!-- Bulk Actions -->
<div class="flex items-center justify-between mb-4 p-3 bg-base-200/50 rounded-lg">
    <span class="text-sm font-medium text-base-content/70">Mark All:</span>
    <div class="flex gap-2">
        <button type="button" onclick="markAll('P')" class="btn btn-sm btn-success btn-outline gap-1">
            <i class="fa-solid fa-check"></i> Present
        </button>
        <button type="button" onclick="markAll('L')" class="btn btn-sm btn-warning btn-outline gap-1">
            <i class="fa-solid fa-clock"></i> Late
        </button>
        <button type="button" onclick="markAll('A')" class="btn btn-sm btn-error btn-outline gap-1">
            <i class="fa-solid fa-xmark"></i> Absent
        </button>
    </div>
</div>

<form method="post" id="attendance-form"
      {% if is_lesson and timetable_entry_id %}
      action="{% url 'academics:take_lesson_attendance' timetable_entry_id %}"
      hx-post="{% url 'academics:take_lesson_attendance' timetable_entry_id %}"
      {% elif is_edit %}
      action="{% url 'academics:class_attendance_edit' class.pk session.pk %}"
      hx-post="{% url 'academics:class_attendance_edit' class.pk session.pk %}"
      {% else %}
      action="{% url 'academics:class_attendance_take' class.pk %}"
      hx-post="{% url 'academics:class_attendance_take' class.pk %}"
      {% endif %}
      hx-target="body"
      hx-swap="beforeend">
    {% csrf_token %}

    <div class="h-[50vh] overflow-y-auto pr-2 space-y-2">
        {% for item in student_list %}
        <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 border border-base-200 rounded-lg hover:bg-base-200/50 gap-3">
            <div class="flex items-center gap-3">
                <div class="avatar placeholder">
                    <div class="w-8 h-8 rounded-full bg-base-300 flex items-center justify-center">
                        <span class="text-xs">{{ item.obj.first_name|slice:":1" }}{{ item.obj.last_name|slice:":1" }}</span>
                    </div>
                </div>
                <div>
                    <div class="font-bold text-sm">{{ item.obj.full_name }}</div>
                    <div class="text-xs opacity-50">{{ item.obj.admission_number }}</div>
                </div>
            </div>

            <!-- Touch-friendly status buttons -->
            <div class="flex items-center gap-1 sm:gap-2">
                <label class="flex-1 sm:flex-none">
                    <input type="radio" name="status_{{ item.obj.id }}" value="P" class="peer hidden" {% if item.status == 'P' %}checked{% endif %} />
                    <span class="flex items-center justify-center gap-1 px-3 py-2 sm:py-1.5 rounded-lg cursor-pointer text-xs font-medium border-2 border-transparent bg-base-200 peer-checked:bg-success/20 peer-checked:border-success peer-checked:text-success transition-all">
                        <i class="fa-solid fa-check"></i>
                        <span class="hidden xs:inline">Present</span>
                    </span>
                </label>
                <label class="flex-1 sm:flex-none">
                    <input type="radio" name="status_{{ item.obj.id }}" value="L" class="peer hidden" {% if item.status == 'L' %}checked{% endif %} />
                    <span class="flex items-center justify-center gap-1 px-3 py-2 sm:py-1.5 rounded-lg cursor-pointer text-xs font-medium border-2 border-transparent bg-base-200 peer-checked:bg-warning/20 peer-checked:border-warning peer-checked:text-warning transition-all">
                        <i class="fa-solid fa-clock"></i>
                        <span class="hidden xs:inline">Late</span>
                    </span>
                </label>
                <label class="flex-1 sm:flex-none">
                    <input type="radio" name="status_{{ item.obj.id }}" value="A" class="peer hidden" {% if item.status == 'A' %}checked{% endif %} />
                    <span class="flex items-center justify-center gap-1 px-3 py-2 sm:py-1.5 rounded-lg cursor-pointer text-xs font-medium border-2 border-transparent bg-base-200 peer-checked:bg-error/20 peer-checked:border-error peer-checked:text-error transition-all">
                        <i class="fa-solid fa-xmark"></i>
                        <span class="hidden xs:inline">Absent</span>
                    </span>
                </label>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="modal-action border-t border-base-200 pt-4 mt-4">
        <button type="button" class="btn" onclick="var d=this.closest('dialog'); if(d) d.close(); else history.back();">Cancel</button>
        <button type="submit" class="btn btn-primary px-8">Save Register</button>
    </div>
</form>

<script>
function markAll(status) {
    const form = document.getElementById('attendance-form');
    const radios = form.querySelectorAll(`input[type="radio"][value="${status}"]`);
    radios.forEach(radio => {
        radio.checked = true;
    });
}
</script>