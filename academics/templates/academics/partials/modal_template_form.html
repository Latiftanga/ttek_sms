{% load core_tags %}
<div class="flex items-center gap-2 mb-3">
    {% if from_class %}
    <button type="button" class="btn btn-ghost btn-sm btn-square"
            hx-get="{% url 'academics:apply_template' from_class %}"
            hx-target="#modal-container"
            hx-swap="innerHTML">
        <i class="fa-solid fa-arrow-left"></i>
    </button>
    {% endif %}
    <h3 class="text-lg font-bold">{% if is_create %}Create{% else %}Edit{% endif %} Subject Template</h3>
</div>
<form method="post"
      action="{% if template %}{% url 'academics:template_edit' template.pk %}{% if from_class %}?from_class={{ from_class }}{% endif %}{% else %}{% url 'academics:template_create' %}{% if from_class %}?from_class={{ from_class }}{% endif %}{% endif %}"
      hx-post="{% if template %}{% url 'academics:template_edit' template.pk %}{% if from_class %}?from_class={{ from_class }}{% endif %}{% else %}{% url 'academics:template_create' %}{% if from_class %}?from_class={{ from_class }}{% endif %}{% endif %}"
      hx-target="{{ modal_target|default:'#modal-content' }}"
      hx-swap="innerHTML">
    {% csrf_token %}
    {% if from_class %}<input type="hidden" name="from_class" value="{{ from_class }}">{% endif %}

    <!-- Name & Active -->
    <div class="flex gap-3 items-center mb-3">
        <input type="text" name="name" value="{{ form.name.value|default:'' }}"
               class="input input-sm input-bordered flex-1" placeholder="Template name" required />
        <label class="label cursor-pointer gap-2">
            <input type="checkbox" name="is_active" class="checkbox checkbox-sm checkbox-primary"
                   {% if form.instance.is_active or is_create %}checked{% endif %} />
            <span class="label-text text-sm">Active</span>
        </label>
    </div>

    <!-- Level Type & Default -->
    <div class="flex gap-3 items-center mb-3">
        <div class="form-control flex-1">
            <label class="label py-0">
                <span class="label-text text-xs">Applicable Level</span>
            </label>
            <select name="level_type" class="select select-sm select-bordered w-full">
                <option value="all" {% if form.level_type.value == 'all' or not form.level_type.value %}selected{% endif %}>All Levels</option>
                <option value="primary" {% if form.level_type.value == 'primary' %}selected{% endif %}>Primary (KG, Basic 1-6)</option>
                <option value="jhs" {% if form.level_type.value == 'jhs' %}selected{% endif %}>JHS (Basic 7-9)</option>
                <option value="shs" {% if form.level_type.value == 'shs' %}selected{% endif %}>SHS</option>
            </select>
        </div>
        <label class="label cursor-pointer gap-2 pt-5">
            <input type="checkbox" name="is_default" class="checkbox checkbox-sm checkbox-secondary"
                   {% if form.is_default.value %}checked{% endif %} />
            <span class="label-text text-sm">Default</span>
        </label>
    </div>

    <!-- Subjects - 2-column grid (no inner scroll) -->
    <div class="text-xs font-medium text-base-content/70 mb-1">Select Subjects:</div>
    <div class="border border-base-300 rounded-lg p-2 max-h-48 overflow-y-auto">
        <div class="grid grid-cols-2 gap-x-3 gap-y-0.5">
            {% for subject in form.subjects.field.queryset %}
            <label class="cursor-pointer flex items-center gap-1.5 py-1 px-1 rounded hover:bg-base-200 text-sm">
                <input type="checkbox" name="subjects" value="{{ subject.pk }}"
                       class="checkbox checkbox-xs checkbox-primary"
                       {% if subject.pk|stringformat:"s" in selected_subject_ids %}checked{% endif %} />
                <span class="truncate flex-1">{{ subject.name }}</span>
                {% if tenant.has_programmes and subject.is_core %}<span class="badge badge-xs badge-primary">C</span>{% endif %}
            </label>
            {% empty %}
            <p class="text-sm text-base-content/50 col-span-2 py-2">No subjects available.</p>
            {% endfor %}
        </div>
    </div>

    {% if form.errors %}
    <div class="alert alert-error mt-3 py-2 text-sm">
        <i class="fa-solid fa-exclamation-circle"></i>
        <span>{{ form.non_field_errors.0|default:"Please fix the errors." }}</span>
    </div>
    {% endif %}

    <div class="modal-action">
        {% if from_class %}
        <button type="button" class="btn btn-sm"
                hx-get="{% url 'academics:apply_template' from_class %}"
                hx-target="#modal-container"
                hx-swap="innerHTML">Cancel</button>
        {% else %}
        <button type="button" class="btn btn-sm" onclick="this.closest('dialog').close()">Cancel</button>
        {% endif %}
        <button type="submit" class="btn btn-sm btn-primary">
            {% if is_create %}Create{% else %}Save{% endif %}
        </button>
    </div>
</form>
