{% load core_tags %}

<div class="flex items-center gap-3 mb-4 pb-3 border-b border-base-200">
    <button type="button" class="btn btn-ghost btn-sm btn-square"
            hx-get="{% url 'academics:class_subjects_modal' class.pk %}"
            hx-target="#modal-edit-content">
        <i class="fa-solid fa-arrow-left"></i>
    </button>
    <div>
        <h3 class="text-lg font-bold">
            {% if allocation %}Edit Subject{% else %}Add Subject{% endif %}
        </h3>
        <p class="text-xs text-base-content/60">{{ class.name }}</p>
    </div>
</div>

<form method="post"
      action="{% url 'academics:class_subject_create' class.pk %}{% if subject_id %}?subject_id={{ subject_id }}{% endif %}"
      hx-post="{% url 'academics:class_subject_create' class.pk %}{% if subject_id %}?subject_id={{ subject_id }}{% endif %}"
      hx-target="#modal-edit-content"
      hx-swap="innerHTML">
    {% csrf_token %}

    {% if subject_id %}
    <input type="hidden" name="subject_id" value="{{ subject_id }}">
    {% endif %}
    
    <div class="space-y-4">
        {% if form.subject.field.queryset.count == 0 and not allocation %}
            <div class="alert alert-warning text-sm">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <div>
                    <p class="font-medium">No available subjects found.</p>
                    <p class="text-xs mt-1">
                        All subjects are already assigned to this class, or no active subjects exist.
                    </p>
                </div>
            </div>
        {% else %}
            {% floating_field form.subject %}
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {% floating_field form.teacher %}
                {% floating_field form.periods_per_week %}
            </div>
        {% endif %}
    </div>

    {% if form.errors %}
    <div class="alert alert-error mt-4 py-2 text-sm">
        <i class="fa-solid fa-exclamation-circle"></i>
        <span>{{ form.non_field_errors.0|default:"Please correct the errors above." }}</span>
    </div>
    {% endif %}

    <div class="modal-action">
        <form method="dialog">
            <button class="btn">Cancel</button>
        </form>
        {% if form.subject.field.queryset.count > 0 or allocation %}
        <button type="submit" class="btn btn-primary">
            {% if allocation %}Save Changes{% else %}Assign Subject{% endif %}
        </button>
        {% endif %}
    </div>
</form>