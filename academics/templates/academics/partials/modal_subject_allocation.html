{% load core_tags %}

<div class="mb-4 pb-3 border-b border-base-200">
    <h3 class="text-lg font-bold">
        {% if allocation %}Edit Subject{% else %}Add Subject{% endif %}
    </h3>
    <p class="text-xs text-base-content/60">{{ class.name }}</p>
</div>

<form method="post"
      action="{% url 'academics:class_subject_create' class.pk %}{% if subject_id %}?subject_id={{ subject_id }}{% endif %}"
      hx-post="{% url 'academics:class_subject_create' class.pk %}{% if subject_id %}?subject_id={{ subject_id }}{% endif %}"
      hx-swap="none">
    {% csrf_token %}

    {% if subject_id %}
    <input type="hidden" name="subject_id" value="{{ subject_id }}">
    {% endif %}
    
    <div class="space-y-4">
        {% if form.subject.field.queryset.count == 0 and not allocation %}
            <div class="alert alert-warning text-sm">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <div>
                    <p class="font-medium">No available subjects found.</p>
                    <p class="text-xs mt-1">
                        All subjects are already assigned to this class, or no active subjects exist.
                    </p>
                </div>
            </div>
        {% else %}
            {% floating_field form.subject %}

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {% floating_field form.teacher %}
                {% floating_field form.periods_per_week %}
            </div>

            <!-- Auto-enroll checkbox -->
            <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox"
                           name="auto_enroll"
                           id="id_auto_enroll"
                           {% if form.auto_enroll.value %}checked{% endif %}
                           class="checkbox checkbox-primary" />
                    <div>
                        <span class="label-text font-medium">Auto-enroll all students</span>
                        <p class="text-xs text-base-content/60 mt-0.5">
                            Uncheck for electives where students choose (e.g., French vs Spanish)
                        </p>
                    </div>
                </label>
            </div>
        {% endif %}
    </div>

    {% if form.errors %}
    <div class="alert alert-error mt-4 py-2 text-sm">
        <i class="fa-solid fa-exclamation-circle"></i>
        <span>{{ form.non_field_errors.0|default:"Please correct the errors above." }}</span>
    </div>
    {% endif %}

    <div class="modal-action">
        <button type="button" class="btn" onclick="var d=this.closest('dialog'); if(d) d.close(); else history.back();">Cancel</button>
        {% if form.subject.field.queryset.count > 0 or allocation %}
        <button type="submit" class="btn btn-primary">
            {% if allocation %}Save Changes{% else %}Assign Subject{% endif %}
        </button>
        {% endif %}
    </div>
</form>