{% load core_tags %}

<h3 class="font-bold text-lg mb-2">
    <i class="fa-solid fa-{% if is_edit %}edit{% else %}calendar-plus{% endif %} text-primary"></i>
    {% if is_edit %}Edit{% else %}Add{% endif %} Lesson
</h3>

<!-- Show slot info -->
<div class="flex items-center gap-2 mb-4 text-sm">
    <span class="badge badge-primary">{{ selected_day_name }}</span>
    <span class="badge badge-secondary">{{ selected_period.name }}</span>
    <span class="text-base-content/50">{{ selected_period.start_time|time:"g:i A" }} - {{ selected_period.end_time|time:"g:i A" }}</span>
</div>

<form hx-post="{% if is_edit %}{% url 'academics:timetable_entry_edit' entry.pk %}{% else %}{% url 'academics:timetable_entry_create' class_obj.pk %}{% endif %}"
      hx-target="#modal-container"
      hx-swap="innerHTML"
      class="space-y-4">
    {% csrf_token %}

    <!-- Hidden fields for period and weekday -->
    <input type="hidden" name="weekday" value="{{ form.weekday.value }}">
    <input type="hidden" name="period" value="{{ form.period.value }}">

    <!-- Subject -->
    <label class="select select-bordered select-sm w-full">
        <span class="label">Subject</span>
        <select name="subject" required>
            <option value="" disabled {% if not form.subject.value %}selected{% endif %}>Select a subject...</option>
            {% for subj in form.fields.subject.queryset %}
            <option value="{{ subj.pk }}" {% if form.subject.value|stringformat:"s" == subj.pk|stringformat:"s" %}selected{% endif %}>
                {{ subj.name }}
            </option>
            {% endfor %}
        </select>
    </label>
    {% if form.subject.errors %}
    <div class="text-xs text-error mt-1 ml-1 flex items-center gap-1">
        <i class="fa-solid fa-circle-exclamation"></i>
        <span>{{ form.subject.errors.0 }}</span>
    </div>
    {% endif %}

    <!-- Teacher -->
    <div>
        <label class="select select-bordered select-sm w-full">
            <span class="label">Teacher</span>
            <select name="teacher" required
                    hx-get="{% url 'academics:teacher_schedule_preview' %}"
                    hx-trigger="change"
                    hx-target="#teacher-schedule-preview"
                    hx-swap="innerHTML"
                    hx-include="[name='weekday']">
                <option value="" disabled {% if not form.teacher.value %}selected{% endif %}>Select a teacher...</option>
                {% for tchr in form.fields.teacher.queryset %}
                <option value="{{ tchr.pk }}" {% if form.teacher.value|stringformat:"s" == tchr.pk|stringformat:"s" %}selected{% endif %}>
                    {{ tchr.full_name }} ({{ tchr.subject_specialization }})
                </option>
                {% endfor %}
            </select>
        </label>
        {% if form.teacher.errors %}
        <div class="text-xs text-error mt-1 ml-1 flex items-center gap-1">
            <i class="fa-solid fa-circle-exclamation"></i>
            <span>{{ form.teacher.errors.0 }}</span>
        </div>
        {% endif %}
        <div id="teacher-schedule-preview"></div>
    </div>

    <!-- Classroom -->
    <label class="select select-bordered select-sm w-full">
        <span class="label">Classroom (Optional)</span>
        <select name="classroom">
            <option value="" {% if not form.classroom.value %}selected{% endif %}>No specific room</option>
            {% for room in form.fields.classroom.queryset %}
            <option value="{{ room.pk }}" {% if form.classroom.value|stringformat:"s" == room.pk|stringformat:"s" %}selected{% endif %}>
                {{ room.name }}{% if room.code %} ({{ room.code }}){% endif %}
            </option>
            {% endfor %}
        </select>
    </label>
    {% if form.classroom.errors %}
    <div class="text-xs text-error mt-1 ml-1 flex items-center gap-1">
        <i class="fa-solid fa-circle-exclamation"></i>
        <span>{{ form.classroom.errors.0 }}</span>
    </div>
    {% endif %}

    <!-- Double Period -->
    {% if existing_is_double is not None %}
    <!-- Adding combined lesson - duration must match existing entries -->
    {% if existing_is_double %}
    <input type="hidden" name="is_double" value="on">
    {% endif %}
    <div class="text-xs text-base-content/50 flex items-center gap-2">
        <i class="fa-solid fa-info-circle"></i>
        {% if existing_is_double %}
        This slot has double period lessons - new lesson will also be double period.
        {% else %}
        This slot has single period lessons - new lesson will also be single period.
        {% endif %}
    </div>
    {% else %}
    <!-- Empty slot - allow choosing duration -->
    <div class="form-control">
        <label class="label cursor-pointer justify-start gap-3">
            <input type="checkbox" name="is_double" class="checkbox checkbox-sm checkbox-primary"
                   {% if form.is_double.value %}checked{% endif %}>
            <div>
                <span class="label-text text-sm font-medium">Double Period</span>
                <p class="text-xs text-base-content/50">Lesson spans two consecutive periods</p>
            </div>
        </label>
        {% if form.is_double.errors %}
        <label class="label">
            <span class="label-text-alt text-error">{{ form.is_double.errors.0 }}</span>
        </label>
        {% endif %}
    </div>
    {% endif %}

    {% if form.non_field_errors %}
    <div class="alert alert-error">
        <i class="fa-solid fa-exclamation-circle"></i>
        <span>{{ form.non_field_errors.0 }}</span>
    </div>
    {% endif %}

    <div class="modal-action">
        <button type="button" class="btn btn-sm btn-ghost" onclick="document.getElementById('modal_form').close()">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary">
            <span class="loading loading-spinner loading-sm loading-indicator hidden"></span>
            <i class="fa-solid fa-{% if is_edit %}save{% else %}plus{% endif %} htmx-indicator-hide"></i>
            {% if is_edit %}Save Changes{% else %}Add Lesson{% endif %}
        </button>
    </div>
</form>
