{% load core_tags %}

<div class="flex flex-col sm:flex-row justify-between items-center mb-4 pt-3 gap-4 sticky top-0 bg-base-100 z-10 pb-2 border-b border-base-200">
    <div>
        <h3 class="text-xl font-bold">
            <i class="fa-solid fa-book-bookmark text-secondary mr-2"></i>
            Manage Electives
        </h3>
        <p class="text-xs text-base-content/60">Select elective subjects for {{ student.full_name }}</p>
    </div>
    {% if required_electives %}
    <div class="badge badge-secondary badge-lg">{{ required_electives }} required</div>
    {% endif %}
</div>

<form method="post"
      action="{% url 'academics:class_student_electives' class.pk student.pk %}"
      hx-post="{% url 'academics:class_student_electives' class.pk student.pk %}"
      hx-target="#modal-edit-content"
      hx-swap="innerHTML">
    {% csrf_token %}

    {% if error %}
    <div class="alert alert-error mb-4 py-2 text-sm">
        <i class="fa-solid fa-circle-exclamation"></i>
        <span>{{ error }}</span>
    </div>
    {% endif %}

    {% if elective_subjects %}
    <div class="space-y-2 max-h-[50vh] overflow-y-auto">
        {% for cs in elective_subjects %}
        <label class="flex items-center gap-3 p-3 rounded-lg border border-base-200 hover:bg-base-200/50 cursor-pointer transition-colors">
            <input type="checkbox"
                   name="electives"
                   value="{{ cs.pk }}"
                   class="checkbox checkbox-secondary checkbox-sm elective-cb"
                   {% if cs.pk in enrolled_ids %}checked{% endif %}
                   onchange="updateElectiveCount()">
            <div class="flex-1">
                <div class="font-medium">{{ cs.subject.name }}</div>
                {% if cs.teacher %}
                <div class="text-xs text-base-content/50">
                    <i class="fa-solid fa-chalkboard-user mr-1"></i>
                    {{ cs.teacher.full_name }}
                </div>
                {% endif %}
            </div>
        </label>
        {% endfor %}
    </div>

    <div class="flex items-center justify-between mt-4 text-sm">
        <span class="text-base-content/60">
            <i class="fa-solid fa-circle-info mr-1"></i>
            Students should have at least {{ required_electives }} elective{{ required_electives|pluralize }}.
        </span>
        <span id="elective-count" class="font-bold"></span>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fa-solid fa-circle-info"></i>
        <span>No elective subjects available for this class.</span>
    </div>
    {% endif %}

    <div class="modal-action border-t border-base-200 pt-4 mt-4">
        <button type="button" class="btn" onclick="var d=this.closest('dialog'); if(d) d.close(); else history.back();">Cancel</button>
        {% if elective_subjects %}
        <button type="submit" class="btn btn-secondary">
            <i class="fa-solid fa-check mr-1"></i>
            Save Electives
        </button>
        {% endif %}
    </div>
</form>

<script>
function updateElectiveCount() {
    const count = document.querySelectorAll('.elective-cb:checked').length;
    const required = {{ required_electives }};
    const el = document.getElementById('elective-count');

    if (count < required) {
        el.innerHTML = '<span class="text-warning">' + count + '/' + required + ' selected</span>';
    } else {
        el.innerHTML = '<span class="text-success">' + count + '/' + required + ' selected</span>';
    }
}
// Initialize on load
updateElectiveCount();
</script>
