{% load core_tags %}
<h3 class="text-lg font-bold mb-6">Generate Invoices</h3>

<form method="post"
      hx-post="{% url 'finance:invoice_generate' %}"
      hx-target="#main-content"
      hx-on:htmx:after-request="if(event.detail.successful && event.detail.elt === this) document.getElementById('invoice-modal').close()">
    {% csrf_token %}

    <div class="space-y-4">
        {% floating_field form.term %}

        {% floating_field form.due_date %}

        <div>
            {% floating_field form.class_assigned "Class" %}
            <p class="text-xs text-base-content/60 mt-1">Generate invoices for all students in this class</p>
        </div>

        <!-- Student Search -->
        <div hx-disinherit="*">
            <label class="input input-bordered w-full flex items-center gap-2">
                <span class="label">Student</span>
                <input type="text"
                       id="student-search"
                       name="q"
                       placeholder="Search by name or admission #..."
                       hx-get="{% url 'finance:student_search' %}"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#student-results"
                       hx-swap="innerHTML"
                       autocomplete="off" />
                <i class="fa-solid fa-search text-base-content/40"></i>
            </label>
            <input type="hidden" name="student" id="student-id" value="">
            <div id="student-results" class="relative"></div>
            <div id="selected-student" class="mt-2 hidden">
                <span class="badge badge-primary gap-2">
                    <span id="selected-student-name"></span>
                    <button type="button" onclick="clearStudent()" class="btn btn-ghost btn-xs btn-circle">
                        <i class="fa-solid fa-times text-xs"></i>
                    </button>
                </span>
            </div>
            <p class="text-xs text-base-content/60 mt-1">Or search for a specific student instead</p>
        </div>
    </div>

    {% if form.errors %}
    <div class="alert alert-error mt-4 py-2 text-sm">
        <i class="fa-solid fa-exclamation-circle"></i>
        <span>{{ form.non_field_errors.0|default:"Please select a class or student." }}</span>
    </div>
    {% endif %}

    <div class="modal-action">
        <button type="button" class="btn" onclick="this.closest('dialog').close()">Cancel</button>
        <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-file-invoice"></i>
            Generate
        </button>
    </div>
</form>

<script>
function selectStudent(id, name) {
    document.getElementById('student-id').value = id;
    document.getElementById('student-search').value = '';
    document.getElementById('selected-student-name').textContent = name;
    document.getElementById('selected-student').classList.remove('hidden');
    document.getElementById('student-results').innerHTML = '';
}

function clearStudent() {
    document.getElementById('student-id').value = '';
    document.getElementById('selected-student').classList.add('hidden');
    document.getElementById('selected-student-name').textContent = '';
}
</script>
