{% load core_tags %}

<h3 class="text-lg font-bold mb-4 flex items-center gap-2">
    <i class="fa-solid fa-users text-secondary"></i>
    Send SMS to Class
</h3>

{% if success %}
<div class="text-center py-8">
    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-success/20 flex items-center justify-center">
        <i class="fa-solid fa-check text-success text-2xl"></i>
    </div>
    <h4 class="font-bold text-lg mb-2">Messages Sent!</h4>
    <div class="stats stats-vertical lg:stats-horizontal shadow mb-4">
        <div class="stat py-2 px-4">
            <div class="stat-title text-xs">Sent</div>
            <div class="stat-value text-success text-xl">{{ sent_count }}</div>
        </div>
        <div class="stat py-2 px-4">
            <div class="stat-title text-xs">Failed</div>
            <div class="stat-value text-error text-xl">{{ failed_count }}</div>
        </div>
        <div class="stat py-2 px-4">
            <div class="stat-title text-xs">Skipped</div>
            <div class="stat-value text-warning text-xl">{{ skipped_count }}</div>
        </div>
    </div>
    <p class="text-sm text-base-content/60 mb-4">Messages have been queued for delivery.</p>
    <button type="button" class="btn btn-primary" onclick="modal_sms.close(); location.reload();">
        Done
    </button>
</div>
{% else %}

{% if error %}
<div class="alert alert-error mb-4">
    <i class="fa-solid fa-circle-exclamation"></i>
    <span>{{ error }}</span>
</div>
{% endif %}

<form method="post"
      action="{% url 'communications:send_to_class' %}"
      hx-post="{% url 'communications:send_to_class' %}"
      hx-target="#modal-sms-content"
      hx-indicator="#send-class-indicator"
      id="send-class-form">
    {% csrf_token %}

    <div class="space-y-4">
        <label class="select select-bordered w-full">
            <span class="label">Select Class <span class="text-error">*</span></span>
            <select name="class_id"
                    required
                    hx-get="{% url 'communications:class_recipients' %}"
                    hx-target="#recipient-info"
                    hx-trigger="change"
                    hx-swap="innerHTML"
                    hx-include="this">
                <option value="">-- Choose a class --</option>
                {% for class in classes %}
                <option value="{{ class.pk }}" {% if selected_class == class.pk %}selected{% endif %}>
                    {{ class.name }}
                </option>
                {% endfor %}
            </select>
        </label>

        <!-- Recipient info (loaded dynamically) -->
        <div id="recipient-info">
            <div class="bg-base-200 rounded-lg p-3 text-sm text-base-content/60">
                <i class="fa-solid fa-info-circle mr-1"></i>
                Select a class to see recipient count
            </div>
        </div>

        {% if templates %}
        <label class="select select-bordered w-full">
            <span class="label">Quick Template</span>
            <select onchange="if(this.value) { document.getElementById('class-message-input').value = this.value; updateClassCharCount(document.getElementById('class-message-input')); }">
                <option value="">-- Select a template --</option>
                {% for template in templates %}
                <option value="{{ template.content }}">{{ template.name }}</option>
                {% endfor %}
            </select>
        </label>
        {% endif %}

        <div>
            <label class="floating-label w-full">
                <span>Message <span class="text-error">*</span></span>
                <textarea id="class-message-input"
                          name="message"
                          class="textarea textarea-bordered w-full h-28"
                          placeholder="Type your message here..."
                          required
                          oninput="updateClassCharCount(this)">{{ message|default:'' }}</textarea>
            </label>
            <div class="flex justify-between text-xs text-base-content/60 mt-1 ml-1">
                <span>
                    <span id="class-char-count" class="font-mono">0</span>/160 chars
                    <span class="mx-1">â€¢</span>
                    <span id="class-sms-count" class="font-bold">1</span> SMS
                </span>
                <span id="class-char-warning" class="text-warning hidden">Long message - may cost more</span>
            </div>
        </div>

        <div class="bg-base-200 rounded-lg p-3">
            <p class="font-medium text-sm mb-2">Available placeholders:</p>
            <div class="flex flex-wrap gap-2">
                <code class="badge badge-ghost badge-sm">{student_name}</code>
                <code class="badge badge-ghost badge-sm">{class_name}</code>
            </div>
        </div>
    </div>

    <div class="modal-action">
        <button type="button" class="btn btn-ghost" onclick="modal_sms.close()">Cancel</button>
        <button type="submit" class="btn btn-primary gap-2" id="send-class-btn">
            <span id="send-class-indicator" class="loading loading-spinner loading-sm htmx-indicator"></span>
            <i class="fa-solid fa-paper-plane"></i>
            Send to All Parents
        </button>
    </div>
</form>

<script>
function updateClassCharCount(textarea) {
    const count = textarea.value.length;
    const smsCount = Math.ceil(count / 160) || 1;
    document.getElementById('class-char-count').textContent = count;
    document.getElementById('class-sms-count').textContent = smsCount;

    const warning = document.getElementById('class-char-warning');
    if (count > 160) {
        warning.classList.remove('hidden');
    } else {
        warning.classList.add('hidden');
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('class-message-input');
    if (textarea && textarea.value) updateClassCharCount(textarea);
});
</script>
{% endif %}
