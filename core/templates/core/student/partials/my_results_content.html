{% load core_tags %}

<!-- Page Header -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl font-bold flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                <i class="fa-solid fa-chart-line text-white"></i>
            </div>
            My Results
        </h1>
        <p class="text-sm text-base-content/60 mt-1">
            {% if student.current_class %}
            <i class="fa-solid fa-chalkboard mr-1"></i>
            {{ student.current_class.name }}
            {% endif %}
        </p>
    </div>

    {% if available_terms %}
    <div class="flex gap-2 items-center">
        <span class="text-sm text-base-content/60">Term:</span>
        <select class="select select-bordered select-sm"
                hx-get="{% url 'core:my_results' %}"
                hx-target="#main-content"
                hx-push-url="true"
                name="term">
            {% for term in available_terms %}
            <option value="{{ term.pk }}" {% if selected_term.pk == term.pk %}selected{% endif %}>
                {{ term.name }} - {{ term.academic_year.name }}
            </option>
            {% endfor %}
        </select>
    </div>
    {% endif %}
</div>

{% if not subject_grades %}
<!-- No Results -->
<div class="card bg-base-100 shadow-sm border border-base-200">
    <div class="card-body py-16 text-center">
        <div class="w-20 h-20 rounded-full bg-info/10 flex items-center justify-center mx-auto mb-4">
            <i class="fa-solid fa-clipboard-list text-info text-3xl"></i>
        </div>
        <h3 class="text-lg font-semibold mb-2">No Results Available</h3>
        <p class="text-base-content/60 max-w-md mx-auto">
            {% if selected_term %}
            Results for {{ selected_term.name }} have not been released yet. Please check back later.
            {% else %}
            No current term is set. Please contact your school administration.
            {% endif %}
        </p>
    </div>
</div>

{% else %}

<!-- Summary Stats -->
{% if term_report %}
<div class="stats stats-vertical lg:stats-horizontal shadow-sm border border-base-200 w-full mb-6 bg-base-100">
    <div class="stat">
        <div class="stat-figure text-primary">
            <i class="fa-solid fa-percent text-2xl"></i>
        </div>
        <div class="stat-title">Average</div>
        <div class="stat-value text-primary">{{ term_report.average|floatformat:1 }}%</div>
        <div class="stat-desc">Overall average</div>
    </div>

    <div class="stat">
        <div class="stat-figure text-secondary">
            <i class="fa-solid fa-trophy text-2xl"></i>
        </div>
        <div class="stat-title">Position</div>
        <div class="stat-value text-secondary">
            {% if term_report.position %}
            {{ term_report.position }}<span class="text-base font-normal">/{{ term_report.out_of }}</span>
            {% else %}
            -
            {% endif %}
        </div>
        <div class="stat-desc">Class rank</div>
    </div>

    <div class="stat">
        <div class="stat-figure text-success">
            <i class="fa-solid fa-check-circle text-2xl"></i>
        </div>
        <div class="stat-title">Passed</div>
        <div class="stat-value text-success">{{ term_report.subjects_passed }}</div>
        <div class="stat-desc">of {{ term_report.subjects_taken }} subjects</div>
    </div>

    {% if term_report.aggregate %}
    <div class="stat">
        <div class="stat-figure text-warning">
            <i class="fa-solid fa-star text-2xl"></i>
        </div>
        <div class="stat-title">Aggregate</div>
        <div class="stat-value text-warning">{{ term_report.aggregate }}</div>
        <div class="stat-desc">Best 6 subjects</div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Subject Grades -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Core Subjects -->
        {% if core_grades %}
        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-body p-4">
                <h2 class="card-title text-base mb-4">
                    <i class="fa-solid fa-book text-primary"></i>
                    Core Subjects
                </h2>

                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr class="text-xs uppercase text-base-content/60">
                                <th>Subject</th>
                                <th class="text-center">Class Score</th>
                                <th class="text-center">Exam</th>
                                <th class="text-center">Total</th>
                                <th class="text-center">Grade</th>
                                <th class="text-center">Position</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for grade in core_grades %}
                            <tr class="hover">
                                <td class="font-medium">{{ grade.subject.name }}</td>
                                <td class="text-center">{{ grade.class_score|floatformat:1|default:"-" }}</td>
                                <td class="text-center">{{ grade.exam_score|floatformat:1|default:"-" }}</td>
                                <td class="text-center font-semibold">{{ grade.total_score|floatformat:1 }}</td>
                                <td class="text-center">
                                    <span class="badge badge-sm
                                        {% if grade.total_score >= 70 %}badge-success
                                        {% elif grade.total_score >= 50 %}badge-info
                                        {% elif grade.total_score >= 40 %}badge-warning
                                        {% else %}badge-error{% endif %}">
                                        {{ grade.grade }}
                                    </span>
                                </td>
                                <td class="text-center text-base-content/60">
                                    {{ grade.position|default:"-" }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Elective Subjects -->
        {% if elective_grades %}
        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-body p-4">
                <h2 class="card-title text-base mb-4">
                    <i class="fa-solid fa-book-open text-secondary"></i>
                    Elective Subjects
                </h2>

                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr class="text-xs uppercase text-base-content/60">
                                <th>Subject</th>
                                <th class="text-center">Class Score</th>
                                <th class="text-center">Exam</th>
                                <th class="text-center">Total</th>
                                <th class="text-center">Grade</th>
                                <th class="text-center">Position</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for grade in elective_grades %}
                            <tr class="hover">
                                <td class="font-medium">{{ grade.subject.name }}</td>
                                <td class="text-center">{{ grade.class_score|floatformat:1|default:"-" }}</td>
                                <td class="text-center">{{ grade.exam_score|floatformat:1|default:"-" }}</td>
                                <td class="text-center font-semibold">{{ grade.total_score|floatformat:1 }}</td>
                                <td class="text-center">
                                    <span class="badge badge-sm
                                        {% if grade.total_score >= 70 %}badge-success
                                        {% elif grade.total_score >= 50 %}badge-info
                                        {% elif grade.total_score >= 40 %}badge-warning
                                        {% else %}badge-error{% endif %}">
                                        {{ grade.grade }}
                                    </span>
                                </td>
                                <td class="text-center text-base-content/60">
                                    {{ grade.position|default:"-" }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1 space-y-6">
        <!-- Remarks -->
        {% if term_report and term_report.class_teacher_remark or term_report.head_teacher_remark %}
        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-body p-4">
                <h2 class="card-title text-base mb-4">
                    <i class="fa-solid fa-comment text-info"></i>
                    Remarks
                </h2>

                {% if term_report.class_teacher_remark %}
                <div class="mb-4">
                    <div class="text-xs uppercase text-base-content/60 mb-1">Class Teacher</div>
                    <p class="text-sm bg-base-200/50 p-3 rounded-lg">
                        {{ term_report.class_teacher_remark }}
                    </p>
                </div>
                {% endif %}

                {% if term_report.head_teacher_remark %}
                <div>
                    <div class="text-xs uppercase text-base-content/60 mb-1">Head Teacher</div>
                    <p class="text-sm bg-base-200/50 p-3 rounded-lg">
                        {{ term_report.head_teacher_remark }}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Grading Scale Legend -->
        {% if grade_scales %}
        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-body p-4">
                <h2 class="card-title text-base mb-4">
                    <i class="fa-solid fa-table text-warning"></i>
                    Grading Scale
                </h2>

                <div class="overflow-x-auto">
                    <table class="table table-xs">
                        <thead>
                            <tr class="text-xs uppercase text-base-content/60">
                                <th>Grade</th>
                                <th>Range</th>
                                <th>Remark</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for scale in grade_scales %}
                            <tr>
                                <td class="font-medium">{{ scale.grade_label }}</td>
                                <td class="text-base-content/60">{{ scale.min_percentage|floatformat:0 }}-{{ scale.max_percentage|floatformat:0 }}%</td>
                                <td class="text-xs">{{ scale.interpretation }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Attendance -->
        {% if term_report and term_report.total_school_days %}
        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-body p-4">
                <h2 class="card-title text-base mb-4">
                    <i class="fa-solid fa-calendar-check text-success"></i>
                    Attendance
                </h2>

                <div class="flex items-center gap-4">
                    <div class="radial-progress text-success"
                         style="--value:{{ term_report.attendance_percentage|default:0 }};--size:4rem;--thickness:5px;">
                        <span class="text-sm font-bold">{{ term_report.attendance_percentage|floatformat:0|default:0 }}%</span>
                    </div>
                    <div>
                        <div class="text-sm">
                            <span class="font-semibold">{{ term_report.days_present|default:0 }}</span>
                            <span class="text-base-content/60">days present</span>
                        </div>
                        <div class="text-xs text-base-content/60">
                            out of {{ term_report.total_school_days }} school days
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
