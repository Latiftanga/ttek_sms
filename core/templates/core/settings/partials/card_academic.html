{% load core_tags %}
<div id="card-academic" class="card bg-base-100 shadow-sm border border-base-200 overflow-hidden">
    <!-- Branded top accent -->
    <div class="h-1 school-gradient-subtle"></div>
    <div class="card-body p-3 sm:p-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg school-gradient flex items-center justify-center">
                    <i class="fa-solid fa-calendar-alt text-white text-sm"></i>
                </div>
                <span class="text-sm sm:text-base">Academic Calendar</span>
            </h3>
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-primary btn-sm gap-1">
                    <i class="fa-solid fa-plus text-xs"></i>
                    <span class="hidden xs:inline">Add</span>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-box w-48 border border-base-200">
                    <li>
                        <button onclick="document.getElementById('modal_academic_year').showModal()" class="text-sm">
                            <i class="fa-solid fa-calendar-plus w-4"></i> New Academic Year
                        </button>
                    </li>
                    <li>
                        <button onclick="document.getElementById('modal_term').showModal()" {% if not academic_years %}disabled{% endif %} class="text-sm">
                            <i class="fa-solid fa-calendar-week w-4"></i> New {{ period_label|default:"Term" }}
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Quick Settings -->
        <div class="grid grid-cols-1 xs:grid-cols-2 gap-2 mb-4">
            <div class="bg-base-200/40 rounded-lg p-2.5 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-school text-primary/60 text-xs"></i>
                    <span class="text-xs text-base-content/70">School Type</span>
                </div>
                <span class="badge badge-sm badge-primary">{{ education_system_display }}</span>
            </div>
            <div class="bg-base-200/40 rounded-lg p-2.5 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-clock text-primary/60 text-xs"></i>
                    <span class="text-xs text-base-content/70">Period</span>
                </div>
                <form hx-post="{% url 'core:settings_update_academic' %}"
                      hx-target="#card-academic"
                      hx-swap="outerHTML"
                      hx-trigger="change">
                    {% csrf_token %}
                    <select name="academic_period_type" class="select select-xs select-bordered bg-base-100 min-h-0 h-6">
                        <option value="term" {% if period_type == "term" %}selected{% endif %}>Terms</option>
                        <option value="semester" {% if period_type == "semester" %}selected{% endif %}>Semesters</option>
                    </select>
                </form>
            </div>
        </div>

        {% if success %}
        {% include "core/partials/alert.html" with type="success" message=success %}
        {% endif %}

        {% if academic_years %}
        <!-- Academic Years List -->
        <div class="space-y-3">
            {% for year in academic_years %}
            <div class="rounded-xl border {% if year.is_current %}border-primary/30 bg-primary/5{% else %}border-base-200 bg-base-200/20{% endif %} overflow-hidden">
                <!-- Year Header -->
                <div class="p-3 flex items-center justify-between {% if year.is_current %}bg-primary/10{% else %}bg-base-200/30{% endif %}">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg {% if year.is_current %}bg-primary text-primary-content{% else %}bg-base-300 text-base-content/60{% endif %} flex items-center justify-center font-bold text-sm">
                            {{ year.start_date|date:"y" }}
                        </div>
                        <div>
                            <div class="font-semibold text-sm flex items-center gap-2">
                                {{ year.name }}
                                {% if year.is_current %}
                                <span class="badge badge-primary badge-xs">Active</span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-base-content/50">
                                {{ year.start_date|date:"M j, Y" }} â€” {{ year.end_date|date:"M j, Y" }}
                            </div>
                        </div>
                    </div>
                    <!-- Actions -->
                    <div class="dropdown dropdown-end">
                        <label tabindex="0" class="btn btn-ghost btn-sm btn-square">
                            <i class="fa-solid fa-ellipsis-vertical"></i>
                        </label>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-box w-44 border border-base-200">
                            {% if not year.is_current %}
                            <li>
                                <form hx-post="{% url 'core:academic_year_set_current' year.pk %}"
                                      hx-target="#card-academic"
                                      hx-swap="outerHTML">
                                    {% csrf_token %}
                                    <button type="submit" class="text-sm">
                                        <i class="fa-solid fa-star w-4 text-warning"></i> Set as Active
                                    </button>
                                </form>
                            </li>
                            {% endif %}
                            <li>
                                <button class="text-sm"
                                        hx-get="{% url 'core:academic_year_edit' year.pk %}"
                                        hx-target="#modal-edit-content"
                                        hx-swap="innerHTML"
                                        onclick="document.getElementById('modal_edit').showModal()">
                                    <i class="fa-solid fa-pen w-4 text-info"></i> Edit Year
                                </button>
                            </li>
                            <li>
                                <form hx-post="{% url 'core:academic_year_delete' year.pk %}"
                                      hx-target="#card-academic"
                                      hx-swap="outerHTML"
                                      hx-confirm="Delete {{ year.name }} and all its {{ period_label_plural|default:'terms'|lower }}?">
                                    {% csrf_token %}
                                    <button type="submit" class="text-sm text-error">
                                        <i class="fa-solid fa-trash w-4"></i> Delete Year
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Terms Section -->
                <div class="p-3">
                    {% if year.terms.all %}
                    <div class="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-3 gap-2">
                        {% for term in year.terms.all %}
                        <div class="group relative flex items-center gap-2 p-2 rounded-lg {% if term.is_current %}bg-primary/10 border border-primary/20{% else %}bg-base-200/50 hover:bg-base-200/70{% endif %} transition-colors">
                            <div class="w-8 h-8 rounded-full {% if term.is_current %}bg-primary text-primary-content{% else %}bg-base-300 text-base-content/60{% endif %} flex items-center justify-center text-xs font-bold">
                                {{ term.term_number }}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-medium truncate">{{ term.name }}</div>
                                <div class="text-[10px] text-base-content/50">
                                    {{ term.start_date|date:"M j" }} - {{ term.end_date|date:"M j" }}
                                </div>
                            </div>
                            {% if term.is_current %}
                            <span class="badge badge-primary badge-xs">Now</span>
                            {% endif %}
                            <button class="btn btn-ghost btn-xs btn-square opacity-0 group-hover:opacity-100 transition-opacity"
                                    hx-get="{% url 'core:term_edit' term.pk %}"
                                    hx-target="#modal-edit-content"
                                    hx-swap="innerHTML"
                                    onclick="document.getElementById('modal_edit').showModal()">
                                <i class="fa-solid fa-pen text-[10px]"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-base-content/40">
                        <i class="fa-solid fa-calendar-xmark text-lg mb-1"></i>
                        <p class="text-xs">No {{ period_label_plural|default:"terms"|lower }} defined</p>
                        <button class="btn btn-ghost btn-xs mt-2" onclick="document.getElementById('modal_term').showModal()">
                            <i class="fa-solid fa-plus text-xs"></i> Add {{ period_label|default:"Term" }}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-base-content/40">
            <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-base-200 flex items-center justify-center">
                <i class="fa-solid fa-calendar-plus text-2xl"></i>
            </div>
            <p class="text-sm font-medium mb-1">No Academic Years</p>
            <p class="text-xs text-base-content/50 mb-3">Create your first academic year to get started</p>
            <button class="btn btn-primary btn-sm" onclick="document.getElementById('modal_academic_year').showModal()">
                <i class="fa-solid fa-plus text-xs"></i> Create Academic Year
            </button>
        </div>
        {% endif %}
    </div>
</div>
