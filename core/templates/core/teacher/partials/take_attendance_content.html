{% load core_tags %}

<!-- Page Header -->
<div class="flex items-center gap-2 sm:gap-3 mb-4">
    <a href="{% url 'core:my_attendance' %}"
       hx-get="{% url 'core:my_attendance' %}"
       hx-target="#main-content"
       hx-push-url="true"
       class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-gradient-to-br from-success to-primary flex items-center justify-center shrink-0"
       title="Back to Attendance">
        <i class="fa-solid fa-arrow-left text-white text-sm sm:text-base"></i>
    </a>
    <div class="flex-1 min-w-0">
        <h1 class="text-base sm:text-xl font-bold flex items-center gap-2">
            Take Attendance
            {% if is_homeroom %}
            <span class="badge badge-primary badge-xs sm:badge-sm">Homeroom</span>
            {% endif %}
        </h1>
        <p class="text-[10px] sm:text-xs text-base-content/60">
            {{ class.name }} &bull; {{ date|date:"D, M j" }}
        </p>
    </div>
    <div class="badge badge-sm sm:badge-lg gap-1 sm:gap-2">
        <i class="fa-solid fa-users"></i>
        {{ student_list|length }}
    </div>
</div>

<!-- Attendance Form -->
<div class="card bg-base-100 shadow-sm border border-base-200">
    <div class="card-body p-0">
        <form method="post"
              hx-post="{% url 'core:take_attendance' class.pk %}"
              hx-target="#main-content"
              id="attendance-form">
            {% csrf_token %}

            <!-- Quick Actions Bar - Sticky on mobile -->
            <div class="sticky top-0 z-10 flex flex-col gap-2 p-3 md:p-4 border-b border-base-200 bg-base-100/95 backdrop-blur-sm">
                <!-- Search and Quick Actions Row -->
                <div class="flex flex-wrap items-center justify-between gap-2">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium hidden sm:inline">Quick:</span>
                        <button type="button" onclick="setAllStatus('P')" class="btn btn-success btn-xs sm:btn-sm gap-1">
                            <i class="fa-solid fa-check"></i>
                            <span class="hidden xs:inline">All</span> Present
                        </button>
                        <button type="button" onclick="setAllStatus('A')" class="btn btn-error btn-xs sm:btn-sm gap-1">
                            <i class="fa-solid fa-xmark"></i>
                            <span class="hidden xs:inline">All</span> Absent
                        </button>
                    </div>
                    <div class="flex items-center gap-1 text-xs sm:text-sm">
                        <span class="text-success font-bold" id="present-count">{{ student_list|length }}</span>
                        <span class="text-base-content/40">/</span>
                        <span class="text-warning font-bold" id="late-count">0</span>
                        <span class="text-base-content/40">/</span>
                        <span class="text-error font-bold" id="absent-count">0</span>
                    </div>
                </div>
                <!-- Search Input (for large classes) -->
                {% if student_list|length > 15 %}
                <div class="flex items-center gap-2">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-base-content/40 text-sm"></i>
                        <input type="text"
                               id="student-search"
                               placeholder="Search student..."
                               class="input input-sm input-bordered w-full pl-9"
                               onkeyup="filterStudents(this.value)">
                    </div>
                    <span id="search-count" class="text-xs text-base-content/60 hidden"></span>
                </div>
                {% endif %}
            </div>

            <!-- Student List -->
            {% if student_list %}

            <!-- Mobile Card View - Touch Optimized -->
            <div class="md:hidden divide-y divide-base-200">
                {% for item in student_list %}
                <div class="student-row p-3 transition-colors {% if item.status == 'P' %}bg-success/10{% elif item.status == 'A' %}bg-error/10{% elif item.status == 'L' %}bg-warning/10{% endif %}"
                     data-student-id="{{ item.obj.pk }}">
                    <div class="flex items-center gap-3">
                        <!-- Student Photo -->
                        <div class="avatar placeholder shrink-0">
                            <div class="w-12 h-12 rounded-full bg-base-300 text-base-content flex items-center justify-center">
                                {% if item.obj.photo %}
                                <img src="{{ item.obj.photo.url }}" alt="{{ item.obj.full_name }}" class="object-cover" loading="lazy" decoding="async" />
                                {% else %}
                                <span class="text-base font-medium">{{ item.obj.first_name|slice:":1" }}{{ item.obj.last_name|slice:":1" }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Student Info -->
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm truncate">{{ item.obj.full_name }}</p>
                            <p class="text-xs text-base-content/50 font-mono">{{ item.obj.admission_number }}</p>
                        </div>

                        <!-- Status Buttons - Large Touch Targets -->
                        <div class="flex items-center gap-1">
                            <input type="radio" name="status_{{ item.obj.pk }}" value="P"
                                   id="m_p_{{ item.obj.pk }}" {% if item.status == 'P' %}checked{% endif %}
                                   class="hidden">
                            <label for="m_p_{{ item.obj.pk }}"
                                   class="btn btn-circle w-11 h-11 min-h-0 {% if item.status == 'P' %}btn-success{% else %}btn-ghost border-base-300{% endif %} status-label"
                                   data-status="P">
                                <i class="fa-solid fa-check text-lg"></i>
                            </label>

                            <input type="radio" name="status_{{ item.obj.pk }}" value="L"
                                   id="m_l_{{ item.obj.pk }}" {% if item.status == 'L' %}checked{% endif %}
                                   class="hidden">
                            <label for="m_l_{{ item.obj.pk }}"
                                   class="btn btn-circle w-11 h-11 min-h-0 {% if item.status == 'L' %}btn-warning{% else %}btn-ghost border-base-300{% endif %} status-label"
                                   data-status="L">
                                <i class="fa-solid fa-clock text-lg"></i>
                            </label>

                            <input type="radio" name="status_{{ item.obj.pk }}" value="A"
                                   id="m_a_{{ item.obj.pk }}" {% if item.status == 'A' %}checked{% endif %}
                                   class="hidden">
                            <label for="m_a_{{ item.obj.pk }}"
                                   class="btn btn-circle w-11 h-11 min-h-0 {% if item.status == 'A' %}btn-error{% else %}btn-ghost border-base-300{% endif %} status-label"
                                   data-status="A">
                                <i class="fa-solid fa-xmark text-lg"></i>
                            </label>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Desktop Table View -->
            <div class="hidden md:block overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr class="bg-base-200">
                            <th class="w-12">#</th>
                            <th>Student</th>
                            <th class="w-40">Admission No.</th>
                            <th class="w-48 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in student_list %}
                        <tr class="student-row hover {% if item.status == 'P' %}bg-success/10{% elif item.status == 'A' %}bg-error/10{% elif item.status == 'L' %}bg-warning/10{% endif %}"
                            data-student-id="{{ item.obj.pk }}">
                            <td class="text-base-content/50">{{ forloop.counter }}</td>
                            <td>
                                <div class="flex items-center gap-3">
                                    <div class="avatar placeholder">
                                        <div class="w-10 h-10 rounded-full bg-base-300 text-base-content flex items-center justify-center">
                                            {% if item.obj.photo %}
                                            <img src="{{ item.obj.photo.url }}" alt="{{ item.obj.full_name }}" loading="lazy" />
                                            {% else %}
                                            <span class="text-sm font-medium">{{ item.obj.first_name|slice:":1" }}{{ item.obj.last_name|slice:":1" }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="font-medium">{{ item.obj.full_name }}</div>
                                </div>
                            </td>
                            <td class="font-mono text-sm text-base-content/70">{{ item.obj.admission_number }}</td>
                            <td>
                                <div class="flex justify-center gap-2">
                                    <input type="radio" name="status_{{ item.obj.pk }}" value="P"
                                           id="d_p_{{ item.obj.pk }}" {% if item.status == 'P' %}checked{% endif %}
                                           class="hidden">
                                    <label for="d_p_{{ item.obj.pk }}"
                                           class="btn btn-sm btn-circle {% if item.status == 'P' %}btn-success{% else %}btn-ghost{% endif %} status-label"
                                           data-status="P" title="Present">
                                        <i class="fa-solid fa-check"></i>
                                    </label>

                                    <input type="radio" name="status_{{ item.obj.pk }}" value="L"
                                           id="d_l_{{ item.obj.pk }}" {% if item.status == 'L' %}checked{% endif %}
                                           class="hidden">
                                    <label for="d_l_{{ item.obj.pk }}"
                                           class="btn btn-sm btn-circle {% if item.status == 'L' %}btn-warning{% else %}btn-ghost{% endif %} status-label"
                                           data-status="L" title="Late">
                                        <i class="fa-solid fa-clock"></i>
                                    </label>

                                    <input type="radio" name="status_{{ item.obj.pk }}" value="A"
                                           id="d_a_{{ item.obj.pk }}" {% if item.status == 'A' %}checked{% endif %}
                                           class="hidden">
                                    <label for="d_a_{{ item.obj.pk }}"
                                           class="btn btn-sm btn-circle {% if item.status == 'A' %}btn-error{% else %}btn-ghost{% endif %} status-label"
                                           data-status="A" title="Absent">
                                        <i class="fa-solid fa-xmark"></i>
                                    </label>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% else %}
            <!-- Empty State -->
            <div class="text-center py-12">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-base-200 flex items-center justify-center">
                    <i class="fa-solid fa-users-slash text-base-content/30 text-2xl"></i>
                </div>
                <h3 class="font-semibold text-base-content/70">No Students</h3>
                <p class="text-sm text-base-content/50">No active students in this class.</p>
            </div>
            {% endif %}

            <!-- Submit Button - Sticky on mobile -->
            {% if student_list %}
            <div class="sticky bottom-0 flex items-center justify-between p-3 md:p-4 border-t border-base-200 bg-base-100/95 backdrop-blur-sm">
                <a href="{% url 'core:my_attendance' %}"
                   hx-get="{% url 'core:my_attendance' %}"
                   hx-target="#main-content"
                   hx-push-url="true"
                   class="btn btn-ghost btn-sm md:btn-md">
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary btn-sm md:btn-md gap-2">
                    <span class="loading loading-spinner loading-sm htmx-indicator"></span>
                    <i class="fa-solid fa-save htmx-hide-on-request"></i>
                    <span class="htmx-hide-on-request">Save</span>
                    <span class="hidden htmx-show-on-request">Saving...</span>
                </button>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- Legend & Help - Hidden on mobile to save space -->
<div class="mt-4 card bg-base-200/50 border border-base-300 hidden md:block">
    <div class="card-body p-4">
        <h3 class="font-semibold text-sm mb-2">
            <i class="fa-solid fa-circle-info text-info mr-1"></i>
            How to mark attendance:
        </h3>
        <div class="flex flex-wrap items-center gap-4 text-sm">
            <div class="flex items-center gap-2">
                <span class="btn btn-success btn-sm btn-circle"><i class="fa-solid fa-check"></i></span>
                <span><strong>Present</strong> - Student is in class</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="btn btn-warning btn-sm btn-circle"><i class="fa-solid fa-clock"></i></span>
                <span><strong>Late</strong> - Student arrived late</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="btn btn-error btn-sm btn-circle"><i class="fa-solid fa-xmark"></i></span>
                <span><strong>Absent</strong> - Student not in class</span>
            </div>
        </div>
        <p class="text-xs text-base-content/60 mt-2">
            <i class="fa-solid fa-lightbulb text-warning mr-1"></i>
            Tip: Use "All Present" button to quickly mark everyone present, then adjust individual students.
        </p>
    </div>
</div>

<script>
function setAllStatus(status) {
    // Get unique student IDs (avoid double-counting mobile + desktop)
    const studentIds = new Set();
    document.querySelectorAll('.student-row').forEach(row => {
        studentIds.add(row.dataset.studentId);
    });

    studentIds.forEach(studentId => {
        // Check all radio inputs for this student (both mobile and desktop)
        const radios = document.querySelectorAll(`input[name="status_${studentId}"][value="${status}"]`);
        radios.forEach(radio => radio.checked = true);

        // Update row styles for both views
        document.querySelectorAll(`.student-row[data-student-id="${studentId}"]`).forEach(row => {
            updateRowStyle(row, status);
        });
    });

    updateSummary();
}

function updateRowStyle(row, status) {
    row.classList.remove('bg-success/10', 'bg-warning/10', 'bg-error/10');

    // Update label styles within this row
    row.querySelectorAll('.status-label').forEach(label => {
        const labelStatus = label.dataset.status;
        label.classList.remove('btn-success', 'btn-warning', 'btn-error');

        // On mobile, unselected buttons have border; on desktop they're ghost
        const isMobile = row.closest('.md\\:hidden') !== null;
        if (isMobile) {
            label.classList.remove('btn-ghost');
            label.classList.add('btn-ghost', 'border-base-300');
        } else {
            label.classList.add('btn-ghost');
        }

        if (labelStatus === status) {
            label.classList.remove('btn-ghost', 'border-base-300');
            if (status === 'P') {
                label.classList.add('btn-success');
                row.classList.add('bg-success/10');
            } else if (status === 'L') {
                label.classList.add('btn-warning');
                row.classList.add('bg-warning/10');
            } else if (status === 'A') {
                label.classList.add('btn-error');
                row.classList.add('bg-error/10');
            }
        }
    });
}

function updateSummary() {
    let present = 0, absent = 0, late = 0;

    // Count unique students (avoid double-counting)
    const counted = new Set();
    document.querySelectorAll('.student-row').forEach(row => {
        const studentId = row.dataset.studentId;
        if (counted.has(studentId)) return;
        counted.add(studentId);

        const checked = document.querySelector(`input[name="status_${studentId}"]:checked`);
        if (checked) {
            if (checked.value === 'P') present++;
            else if (checked.value === 'A') absent++;
            else if (checked.value === 'L') late++;
        }
    });

    document.getElementById('present-count').textContent = present;
    document.getElementById('absent-count').textContent = absent;
    document.getElementById('late-count').textContent = late;
}

// Initialize event listeners
document.querySelectorAll('.status-label').forEach(label => {
    label.addEventListener('click', function() {
        const row = this.closest('.student-row');
        const studentId = row.dataset.studentId;
        const status = this.dataset.status;

        // Sync the other view (mobile <-> desktop)
        document.querySelectorAll(`.student-row[data-student-id="${studentId}"]`).forEach(r => {
            updateRowStyle(r, status);
            // Also check the corresponding radio in the other view
            const radio = r.querySelector(`input[value="${status}"]`);
            if (radio) radio.checked = true;
        });

        setTimeout(updateSummary, 10);
    });
});

// Initial summary update
updateSummary();

// Student search/filter function
function filterStudents(query) {
    query = query.toLowerCase().trim();
    let visibleCount = 0;
    const totalCount = document.querySelectorAll('.student-row').length / 2; // Divide by 2 for mobile+desktop

    document.querySelectorAll('.student-row').forEach(row => {
        const studentName = row.querySelector('.font-medium')?.textContent?.toLowerCase() || '';
        const admissionNo = row.querySelector('.font-mono')?.textContent?.toLowerCase() || '';

        if (studentName.includes(query) || admissionNo.includes(query) || query === '') {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Update search count indicator
    const searchCount = document.getElementById('search-count');
    if (searchCount) {
        if (query) {
            searchCount.textContent = `${visibleCount / 2} of ${totalCount}`;
            searchCount.classList.remove('hidden');
        } else {
            searchCount.classList.add('hidden');
        }
    }
}

// Double-submit prevention
(function() {
    const form = document.getElementById('attendance-form');
    if (!form) return;

    let isSubmitting = false;

    form.addEventListener('submit', function(e) {
        if (isSubmitting) {
            e.preventDefault();
            return false;
        }

        isSubmitting = true;

        // Disable all buttons in the form
        form.querySelectorAll('button[type="submit"]').forEach(btn => {
            btn.disabled = true;
        });

        // Re-enable after 10 seconds (in case of error)
        setTimeout(() => {
            isSubmitting = false;
            form.querySelectorAll('button[type="submit"]').forEach(btn => {
                btn.disabled = false;
            });
        }, 10000);
    });
})();
</script>
