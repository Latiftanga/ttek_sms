{% load core_tags %}

<div id="enter-scores-page">
<!-- Page Header -->
<div class="flex items-center gap-2 sm:gap-3 mb-4">
    <a href="{% url 'core:my_grading' %}"
       hx-get="{% url 'core:my_grading' %}"
       hx-target="#main-content"
       hx-push-url="true"
       hx-swap="innerHTML show:window:top"
       class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center shrink-0"
       title="Back to Grading">
        <i class="fa-solid fa-arrow-left text-white text-sm sm:text-base"></i>
    </a>
    <div class="flex-1 min-w-0">
        <h1 class="text-base sm:text-xl font-bold truncate">{{ subject.name }}</h1>
        <p class="text-[10px] sm:text-xs text-base-content/60">{{ class_obj.name }}</p>
    </div>
    <div class="flex items-center gap-1 shrink-0">
        {% if grades_locked %}
        <span class="badge badge-warning badge-sm gap-1">
            <i class="fa-solid fa-lock text-xs"></i>
            <span class="hidden sm:inline">Locked</span>
        </span>
        {% endif %}
        {% if view_mode == 'student' %}
        <a href="{% url 'core:enter_scores' class_obj.pk subject.pk %}"
           hx-get="{% url 'core:enter_scores' class_obj.pk subject.pk %}"
           hx-target="#main-content"
           hx-push-url="true"
           hx-swap="innerHTML"
           class="btn btn-ghost btn-sm btn-square"
           title="Switch to table view">
            <i class="fa-solid fa-table-cells"></i>
        </a>
        {% else %}
        <a href="{% url 'core:enter_scores' class_obj.pk subject.pk %}?view=student"
           hx-get="{% url 'core:enter_scores' class_obj.pk subject.pk %}?view=student"
           hx-target="#main-content"
           hx-push-url="true"
           hx-swap="innerHTML"
           class="btn btn-ghost btn-sm btn-square"
           title="Switch to student view">
            <i class="fa-solid fa-id-card"></i>
        </a>
        {% endif %}
        {% if not grades_locked %}
        <button class="btn btn-ghost btn-sm btn-square"
                hx-get="{% url 'gradebook:assignments' subject.pk %}"
                hx-target="#assignments-container"
                hx-swap="innerHTML"
                hx-on::after-request="modal_assignments.showModal()"
                title="Manage Assignments">
            <i class="fa-solid fa-cog"></i>
        </button>
        {% endif %}
        <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost btn-sm btn-square" title="More options">
                <i class="fa-solid fa-ellipsis-v"></i>
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-30 w-48 p-2 shadow-lg border border-base-200">
                <li><a href="{% url 'core:export_scores' class_obj.pk subject.pk %}"><i class="fa-solid fa-download text-success"></i> Export CSV</a></li>
                <li><a href="{% url 'core:export_scores' class_obj.pk subject.pk %}?format=xlsx"><i class="fa-solid fa-file-excel text-success"></i> Export Excel</a></li>
                {% if not grades_locked %}
                <li class="border-t border-base-200 mt-1 pt-1">
                    <button onclick="modal_import.showModal()"><i class="fa-solid fa-upload text-primary"></i> Import Scores</button>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- Refreshable content area -->
<div id="score-entry-container"
     hx-get="{% url 'core:enter_scores' class_obj.pk subject.pk %}"
     hx-trigger="assignmentsChanged from:body"
     hx-select="#score-entry-container"
     hx-swap="outerHTML">

{% if grades_locked %}
<div class="alert alert-warning mb-4 py-2">
    <i class="fa-solid fa-lock"></i>
    <span class="text-sm">Grades locked - view only</span>
</div>
{% endif %}

{% if not assignments %}
<!-- No Assignments -->
<div class="card bg-base-100 shadow-sm border border-base-200">
    <div class="card-body py-8 text-center">
        <div class="w-14 h-14 mx-auto mb-3 rounded-full bg-warning/10 flex items-center justify-center">
            <i class="fa-solid fa-clipboard-list text-warning text-xl"></i>
        </div>
        <h3 class="font-semibold mb-2">No Assignments Yet</h3>
        <p class="text-sm text-base-content/60 mb-4">
            Create assignments (tests, quizzes) to start entering scores.
        </p>
        {% if not grades_locked %}
        <button class="btn btn-primary"
                hx-get="{% url 'gradebook:assignments' subject.pk %}"
                hx-target="#assignments-container"
                hx-swap="innerHTML"
                hx-on::after-request="modal_assignments.showModal()">
            <i class="fa-solid fa-plus"></i>
            Create Assignments
        </button>
        {% endif %}
    </div>
</div>

{% elif not students %}
<!-- No Students -->
<div class="card bg-base-100 shadow-sm border border-base-200">
    <div class="card-body py-8 text-center">
        <div class="w-14 h-14 mx-auto mb-3 rounded-full bg-info/10 flex items-center justify-center">
            <i class="fa-solid fa-users-slash text-info text-xl"></i>
        </div>
        <h3 class="font-semibold mb-2">No Students</h3>
        <p class="text-sm text-base-content/60">No active students in this class.</p>
    </div>
</div>

{% else %}

{% if view_mode == 'student' and current_student %}
<!-- STUDENT VIEW - Per-student with navigation -->
<div class="card bg-base-100 shadow-sm border border-base-200">
    <div class="card-body p-4">
        <!-- Navigation Header -->
        <div class="flex items-center gap-2 mb-4">
            {% if prev_student %}
            <a href="{% url 'core:enter_scores' class_obj.pk subject.pk %}?view=student&student_id={{ prev_student.pk }}"
               hx-get="{% url 'core:enter_scores' class_obj.pk subject.pk %}?view=student&student_id={{ prev_student.pk }}"
               hx-target="#main-content"
               hx-push-url="true"
               hx-swap="innerHTML"
               hx-select="unset"
               class="btn btn-ghost btn-circle min-w-[44px] min-h-[44px]"
               title="Previous student">
                <i class="fa-solid fa-chevron-left"></i>
            </a>
            {% else %}
            <button class="btn btn-ghost btn-circle btn-disabled min-w-[44px] min-h-[44px]" disabled>
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            {% endif %}

            <div class="flex-1 text-center min-w-0">
                <div class="flex items-center justify-center gap-2 mb-1">
                    <div class="avatar placeholder">
                        <div class="w-10 h-10 rounded-full bg-base-300 text-base-content flex items-center justify-center">
                            {% if current_student.photo %}
                            <img src="{{ current_student.photo.url }}" alt="{{ current_student.full_name }}" class="object-cover" />
                            {% else %}
                            <span class="text-sm font-medium">{{ current_student.first_name|slice:":1" }}{{ current_student.last_name|slice:":1" }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <p class="font-semibold truncate">{{ current_student.full_name }}</p>
                <p class="text-xs text-base-content/60">{{ current_student_index|add:1 }} of {{ students|length }}</p>
            </div>

            {% if next_student %}
            <a href="{% url 'core:enter_scores' class_obj.pk subject.pk %}?view=student&student_id={{ next_student.pk }}"
               hx-get="{% url 'core:enter_scores' class_obj.pk subject.pk %}?view=student&student_id={{ next_student.pk }}"
               hx-target="#main-content"
               hx-push-url="true"
               hx-swap="innerHTML"
               hx-select="unset"
               class="btn btn-ghost btn-circle min-w-[44px] min-h-[44px]"
               title="Next student">
                <i class="fa-solid fa-chevron-right"></i>
            </a>
            {% else %}
            <button class="btn btn-ghost btn-circle btn-disabled min-w-[44px] min-h-[44px]" disabled>
                <i class="fa-solid fa-chevron-right"></i>
            </button>
            {% endif %}
        </div>

        {% if grades_locked %}
        <div class="alert alert-warning py-2 mb-4">
            <i class="fa-solid fa-lock text-sm"></i>
            <span class="text-sm">Grades locked - view only</span>
        </div>
        {% endif %}

        <!-- Assignment Scores -->
        {% if assignments %}
        <div class="divide-y divide-base-200">
            {% for assignment in assignments %}
            <div class="flex items-center justify-between gap-3 py-3">
                <div class="flex-1 min-w-0">
                    <p class="font-medium">{{ assignment.name }}</p>
                    <p class="text-xs text-base-content/60 mt-0.5">
                        <span class="badge badge-ghost badge-sm">{{ assignment.assessment_category.short_name }}</span>
                        <span class="ml-1">Max {{ assignment.points_possible }}</span>
                    </p>
                </div>
                <input type="number"
                       inputmode="decimal"
                       name="points"
                       value="{% with score=current_student_scores|get_item:assignment.id %}{{ score|default:'' }}{% endwith %}"
                       min="0"
                       max="{{ assignment.points_possible }}"
                       step="0.5"
                       placeholder="--"
                       class="input input-bordered w-20 h-12 text-center text-lg font-bold"
                       data-student="{{ current_student.id }}"
                       data-assignment="{{ assignment.id }}"
                       data-max="{{ assignment.points_possible }}"
                       {% if grades_locked %}disabled{% endif %}
                       hx-post="{% url 'gradebook:score_save' %}"
                       hx-trigger="change delay:300ms, blur"
                       hx-vals='{"student_id": "{{ current_student.id }}", "assignment_id": "{{ assignment.id }}"}'
                       hx-include="this"
                       hx-swap="none" />
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-base-content/40">
            <i class="fa-solid fa-clipboard-list text-3xl mb-2"></i>
            <p class="text-sm">No assignments yet</p>
        </div>
        {% endif %}

        <!-- Jump to Student -->
        <div class="mt-4 pt-4 border-t border-base-200">
            <label class="label py-1">
                <span class="label-text text-xs">Jump to student</span>
            </label>
            <select class="select select-bordered select-sm w-full"
                    hx-get="{% url 'core:enter_scores' class_obj.pk subject.pk %}"
                    hx-target="#main-content"
                    hx-push-url="true"
                    hx-swap="innerHTML"
                    hx-select="unset"
                    hx-trigger="change"
                    hx-include="this"
                    name="student_id"
                    hx-vals='{"view": "student"}'>
                {% for s in students %}
                <option value="{{ s.pk }}" {% if s.pk == current_student.pk %}selected{% endif %}>
                    {{ forloop.counter }}. {{ s.full_name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

{% else %}
<!-- TABLE VIEW - Full grid (default view) -->
<div id="table-score-view">
    <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-0">
            <!-- Category Legend -->
            <div class="flex flex-wrap items-center gap-3 p-3 border-b border-base-200 bg-base-200/30">
                <span class="text-xs font-medium">Categories:</span>
                {% for cat in categories %}
                <span class="badge badge-outline badge-xs gap-1">{{ cat.name|escape }} ({{ cat.percentage }}%)</span>
                {% endfor %}
            </div>

            <!-- Scores Table -->
            <div class="overflow-x-auto">
                <table class="table table-sm table-pin-rows table-pin-cols">
                    <thead>
                        <tr class="bg-base-200">
                            <th class="bg-base-200 z-20 min-w-[180px]">Student</th>
                            {% for assignment in assignments %}
                            <th class="text-center min-w-[70px]">
                                <div class="text-[10px] font-normal text-base-content/50">{{ assignment.assessment_category.short_name }}</div>
                                <div class="font-medium text-xs">{{ assignment.name }}</div>
                                <div class="text-[10px] text-base-content/50">/{{ assignment.points_possible }}</div>
                            </th>
                            {% endfor %}
                            <th class="text-center bg-base-200 min-w-[60px]">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr class="hover">
                            <td class="bg-base-100 z-10">
                                <div class="flex items-center gap-2">
                                    <div class="avatar placeholder">
                                        <div class="w-7 h-7 rounded-full bg-base-300 text-base-content flex items-center justify-center">
                                            {% if student.photo %}
                                            <img src="{{ student.photo.url }}" alt="" loading="lazy" />
                                            {% else %}
                                            <span class="text-[10px]">{{ student.first_name|slice:":1" }}{{ student.last_name|slice:":1" }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-xs">{{ student.full_name }}</div>
                                </div>
                            </td>
                            {% for assignment in assignments %}
                            <td class="text-center p-1">
                                {% with score=scores_dict|get_item:student.id|get_item:assignment.id %}
                                <input type="number"
                                       inputmode="decimal"
                                       name="points"
                                       value="{{ score|default:'' }}"
                                       min="0"
                                       max="{{ assignment.points_possible }}"
                                       step="0.5"
                                       class="input input-bordered input-xs w-16 text-center score-input-desktop"
                                       data-student="{{ student.id }}"
                                       data-assignment="{{ assignment.id }}"
                                       data-max="{{ assignment.points_possible }}"
                                       {% if grades_locked %}disabled{% endif %}
                                       hx-post="{% url 'gradebook:score_save' %}"
                                       hx-trigger="change delay:300ms, blur"
                                       hx-vals='{"student_id": "{{ student.id }}", "assignment_id": "{{ assignment.id }}"}'
                                       hx-include="this"
                                       hx-swap="none" />
                                {% endwith %}
                            </td>
                            {% endfor %}
                            <td class="text-center bg-base-100 font-bold text-xs">
                                <span class="student-total" data-student="{{ student.id }}">{% with total=student_totals|get_item:student.id %}{{ total|default:"-" }}{% endwith %}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Auto-save indicator -->
<div class="mt-4 p-3 bg-base-200/50 rounded-lg text-center">
    <span class="text-xs text-base-content/60">
        <i class="fa-solid fa-circle-check text-success"></i>
        Scores save automatically
    </span>
</div>

<!-- Styles for score input feedback -->
<style>
.score-input.input-error, .score-input-desktop.input-error {
    border-color: oklch(var(--er)) !important;
    background-color: oklch(var(--er) / 0.1) !important;
    animation: shake-input 0.3s ease-in-out;
}
.score-input.input-success, .score-input-desktop.input-success {
    border-color: oklch(var(--su)) !important;
    background-color: oklch(var(--su) / 0.15) !important;
}
@keyframes shake-input {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-3px); }
    40% { transform: translateX(3px); }
    60% { transform: translateX(-3px); }
    80% { transform: translateX(3px); }
}
</style>

<!-- Error tooltip (fixed position, stays in viewport) -->
<div id="score-error-tooltip-teacher" class="fixed z-[100] hidden pointer-events-none">
    <div class="bg-error text-error-content text-xs rounded-lg shadow-lg px-3 py-2 max-w-52 pointer-events-auto">
        <div class="flex items-start gap-2">
            <i class="fa-solid fa-circle-exclamation mt-0.5 flex-shrink-0"></i>
            <div>
                <div class="font-semibold" id="tooltip-message-teacher"></div>
                <div class="text-error-content/80 mt-0.5 text-[11px]" id="tooltip-hint-teacher"></div>
            </div>
        </div>
    </div>
</div>

<!-- Toast for errors -->
<div id="score-toast-teacher" class="toast toast-top toast-end z-50" style="display: none;">
    <div class="alert alert-error">
        <span id="score-toast-message-teacher"></span>
    </div>
</div>

<script>
// Calculate totals for desktop table view
function calculateTotals() {
    // Exit if not on score entry page
    if (!document.getElementById('score-entry-container')) return;

    var students = {};
    document.querySelectorAll('.score-input-desktop').forEach(function(input) {
        var studentId = input.dataset.student;
        var value = parseFloat(input.value) || 0;
        if (!students[studentId]) students[studentId] = 0;
        students[studentId] += value;
    });
    document.querySelectorAll('.student-total').forEach(function(span) {
        var studentId = span.dataset.student;
        var total = students[studentId] || 0;
        span.textContent = total > 0 ? total.toFixed(1) : '-';
    });
}

// ============ Validation & Feedback System ============
var errorTooltipTimeout = null;
var typingDebounceTimer = null;

function showToastTeacher(message, type) {
    const toast = document.getElementById('score-toast-teacher');
    const msgEl = document.getElementById('score-toast-message-teacher');
    if (!toast || !msgEl) return;

    const alertEl = toast.querySelector('.alert');
    msgEl.textContent = message;
    alertEl.className = 'alert alert-' + (type === 'error' ? 'error' : 'success');
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, type === 'error' ? 5000 : 2500);
}

function showErrorTooltipTeacher(input, message, hint) {
    const tooltip = document.getElementById('score-error-tooltip-teacher');
    const messageEl = document.getElementById('tooltip-message-teacher');
    const hintEl = document.getElementById('tooltip-hint-teacher');

    if (!tooltip) return;

    if (errorTooltipTimeout) clearTimeout(errorTooltipTimeout);

    messageEl.textContent = message;
    hintEl.textContent = hint || '';
    hintEl.style.display = hint ? 'block' : 'none';

    // Fixed positioning - relative to viewport
    const rect = input.getBoundingClientRect();
    const tooltipWidth = 210;
    const tooltipHeight = 60;
    const padding = 8;

    let top = rect.bottom + padding;
    let left = rect.left;

    if (top + tooltipHeight > window.innerHeight) {
        top = rect.top - tooltipHeight - padding;
    }
    if (left + tooltipWidth > window.innerWidth - padding) {
        left = window.innerWidth - tooltipWidth - padding;
    }
    if (left < padding) left = padding;
    if (top < padding) top = padding;

    tooltip.style.top = top + 'px';
    tooltip.style.left = left + 'px';
    tooltip.classList.remove('hidden');

    errorTooltipTimeout = setTimeout(() => {
        tooltip.classList.add('hidden');
    }, 4000);
}

function hideErrorTooltipTeacher() {
    const tooltip = document.getElementById('score-error-tooltip-teacher');
    if (tooltip) tooltip.classList.add('hidden');
}

function validateScoreTeacher(value, max) {
    if (value === "") return { valid: true };
    var num = parseFloat(value);
    if (isNaN(num)) return { valid: false, message: "Enter a valid number", hint: "Use digits only, like 85 or 85.5" };
    if (num < 0) return { valid: false, message: "Cannot be negative", hint: "Scores must be 0 or higher" };
    if (num > max) return { valid: false, message: "Maximum is " + max, hint: "Enter a value between 0 and " + max };
    var decimalPart = value.split(".")[1];
    if (decimalPart && decimalPart.length > 2) {
        return { valid: false, message: "Max 2 decimal places", hint: "Use at most 2 decimal places" };
    }
    return { valid: true };
}

// Visual feedback on save with validation
function setupInputFeedback() {
    // Exit if not on score entry page
    if (!document.getElementById('score-entry-container')) return;

    document.querySelectorAll('.score-input, .score-input-desktop').forEach(input => {
        // Skip if already initialized
        if (input.dataset.validationInit) return;
        input.dataset.validationInit = 'true';

        // Real-time validation while typing
        input.addEventListener('input', function() {
            const inputEl = this;
            const max = parseFloat(this.dataset.max);
            const value = this.value.trim();
            const validation = validateScoreTeacher(value, max);

            if (typingDebounceTimer) clearTimeout(typingDebounceTimer);

            if (!validation.valid && value !== '') {
                this.classList.add('input-error');
                // Show tooltip after brief delay (150ms) for snappy mobile feedback
                typingDebounceTimer = setTimeout(function() {
                    showErrorTooltipTeacher(inputEl, validation.message, validation.hint);
                }, 150);
            } else {
                this.classList.remove('input-error');
                hideErrorTooltipTeacher();
            }

            calculateTotals();
        });

        // Validate on blur before HTMX sends
        input.addEventListener('blur', function() {
            const max = parseFloat(this.dataset.max);
            const value = this.value.trim();
            const validation = validateScoreTeacher(value, max);

            if (!validation.valid && value !== '') {
                this.classList.add('input-error');
                showToastTeacher(validation.message, 'error');
                showErrorTooltipTeacher(this, validation.message, validation.hint);
                // Cancel HTMX by removing the trigger temporarily
                this.setAttribute('data-hx-trigger-backup', this.getAttribute('hx-trigger') || '');
                this.removeAttribute('hx-trigger');
                // Restore after a moment
                setTimeout(() => {
                    const backup = this.getAttribute('data-hx-trigger-backup');
                    if (backup) this.setAttribute('hx-trigger', backup);
                }, 100);
            }
        });
    });
}

// Intercept HTMX requests for validation
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    const input = evt.detail.elt;
    if (!input.classList.contains('score-input') && !input.classList.contains('score-input-desktop')) return;

    const max = parseFloat(input.dataset.max);
    const value = input.value.trim();
    const validation = validateScoreTeacher(value, max);

    if (!validation.valid && value !== '') {
        evt.preventDefault();
        input.classList.add('input-error');
        showToastTeacher(validation.message, 'error');
        showErrorTooltipTeacher(input, validation.message, validation.hint);
    }
});

// HTMX feedback - handle both success and errors
document.body.addEventListener('htmx:afterRequest', function(evt) {
    const input = evt.detail.elt;
    if (!input.classList.contains('score-input') && !input.classList.contains('score-input-desktop')) return;

    if (evt.detail.successful) {
        // Check for error in HX-Trigger header
        const trigger = evt.detail.xhr.getResponseHeader('HX-Trigger');
        if (trigger) {
            try {
                const triggerData = JSON.parse(trigger);
                if (triggerData.scoreError) {
                    input.classList.add('input-error');
                    input.classList.remove('input-success');
                    showToastTeacher(triggerData.scoreError.message, 'error');
                    showErrorTooltipTeacher(input, triggerData.scoreError.message, triggerData.scoreError.hint);
                    if (triggerData.revertScore) {
                        input.value = triggerData.revertScore.value;
                    }
                    return;
                }
                if (triggerData.showToast && triggerData.showToast.type === 'error') {
                    input.classList.add('input-error');
                    showToastTeacher(triggerData.showToast.message, 'error');
                    return;
                }
            } catch(e) {}
        }

        // Success
        input.classList.remove('input-error');
        input.classList.add('input-success');
        setTimeout(() => input.classList.remove('input-success'), 800);
    } else {
        // Request failed
        input.classList.add('input-error');
        showToastTeacher('Failed to save score', 'error');
        setTimeout(() => input.classList.remove('input-error'), 2000);
    }
});

// Keyboard navigation for table view score inputs
function setupKeyboardNavigation() {
    var tableView = document.getElementById('table-score-view');
    if (!tableView) return;

    var inputs = Array.from(tableView.querySelectorAll('.score-input-desktop:not([disabled])'));
    if (inputs.length === 0) return;

    inputs.forEach(function(input, index) {
        // Skip if already initialized
        if (input.dataset.keynavInit) return;
        input.dataset.keynavInit = 'true';

        input.addEventListener('keydown', function(e) {
            var currentIndex = inputs.indexOf(this);
            var nextInput = null;

            if (e.key === 'Tab' && !e.shiftKey) {
                // Tab forward - move to next input
                if (currentIndex < inputs.length - 1) {
                    e.preventDefault();
                    nextInput = inputs[currentIndex + 1];
                }
            } else if (e.key === 'Tab' && e.shiftKey) {
                // Shift+Tab - move to previous input
                if (currentIndex > 0) {
                    e.preventDefault();
                    nextInput = inputs[currentIndex - 1];
                }
            } else if (e.key === 'Enter') {
                // Enter - move to next input (same as Tab)
                e.preventDefault();
                if (currentIndex < inputs.length - 1) {
                    nextInput = inputs[currentIndex + 1];
                }
            } else if (e.key === 'ArrowRight') {
                // Arrow right - move to next assignment (same student)
                e.preventDefault();
                if (currentIndex < inputs.length - 1) {
                    nextInput = inputs[currentIndex + 1];
                }
            } else if (e.key === 'ArrowLeft') {
                // Arrow left - move to previous assignment (same student)
                e.preventDefault();
                if (currentIndex > 0) {
                    nextInput = inputs[currentIndex - 1];
                }
            } else if (e.key === 'ArrowDown') {
                // Arrow down - move to same assignment next student
                e.preventDefault();
                var row = this.closest('tr');
                var cellIndex = this.closest('td').cellIndex;
                var nextRow = row.nextElementSibling;
                if (nextRow) {
                    var nextCell = nextRow.cells[cellIndex];
                    if (nextCell) {
                        nextInput = nextCell.querySelector('.score-input-desktop:not([disabled])');
                    }
                }
            } else if (e.key === 'ArrowUp') {
                // Arrow up - move to same assignment previous student
                e.preventDefault();
                var row = this.closest('tr');
                var cellIndex = this.closest('td').cellIndex;
                var prevRow = row.previousElementSibling;
                if (prevRow) {
                    var prevCell = prevRow.cells[cellIndex];
                    if (prevCell) {
                        nextInput = prevCell.querySelector('.score-input-desktop:not([disabled])');
                    }
                }
            }

            if (nextInput) {
                nextInput.focus();
                nextInput.select();
            }
        });
    });
}

// Initialize immediately
setupInputFeedback();
calculateTotals();
setupKeyboardNavigation();

// Re-init after HTMX swaps
document.body.addEventListener('htmx:afterSwap', function() {
    if (document.getElementById('score-entry-container')) {
        setupInputFeedback();
        calculateTotals();
        setupKeyboardNavigation();
    }
});
</script>
{% endif %}
</div><!-- end score-entry-container -->


<!-- Assignments Modal -->
<dialog id="modal_assignments" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </form>
        <div id="assignments-container">
            <div class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Import Scores Modal -->
<dialog id="modal_import" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </form>
        <h3 class="text-lg font-bold mb-4">
            <i class="fa-solid fa-file-import text-primary"></i>
            Import Scores
        </h3>

        <div id="import-content">
            <div class="alert alert-info mb-4 text-sm">
                <i class="fa-solid fa-circle-info"></i>
                <div>
                    <p class="font-medium">How to import:</p>
                    <ol class="list-decimal list-inside mt-1 space-y-1">
                        <li>Export current scores first</li>
                        <li>Fill in scores in the file</li>
                        <li>Upload the completed file</li>
                    </ol>
                </div>
            </div>

            <form hx-post="{% url 'core:import_scores' class_obj.pk subject.pk %}"
                  hx-target="#import-content"
                  hx-swap="innerHTML"
                  hx-encoding="multipart/form-data">
                {% csrf_token %}
                <div class="form-control">
                    <input type="file"
                           name="file"
                           accept=".csv,.xlsx,.xls"
                           class="file-input file-input-bordered w-full"
                           required />
                    <label class="label">
                        <span class="label-text-alt">CSV or Excel file</span>
                    </label>
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="modal_import.close()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-upload"></i>
                        Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
</div><!-- end enter-scores-page -->
