{% load core_tags %}

<div class="flex flex-col sm:flex-row justify-between items-center mb-4 pt-3 gap-4 sticky top-0 bg-base-100 z-10 pb-2 border-b border-base-200">
    <div>
        <h3 class="text-xl font-bold">
            <i class="fa-solid fa-users-gear text-secondary mr-2"></i>
            Bulk Assign Electives
        </h3>
        <p class="text-xs text-base-content/60">Assign elective subjects to multiple students</p>
    </div>
</div>

{% if error %}
<div class="alert alert-error mb-4 py-2 text-sm">
    <i class="fa-solid fa-circle-exclamation"></i>
    <span>{{ error }}</span>
</div>
{% endif %}

{% if not students_needing_electives %}
<div class="alert alert-success mb-4">
    <i class="fa-solid fa-check-circle"></i>
    <span>All students have their required {{ required_electives }} elective(s) assigned.</span>
</div>
<div class="modal-action border-t border-base-200 pt-4 mt-4">
    <form method="dialog">
        <button class="btn">Close</button>
    </form>
</div>

{% elif not elective_subjects %}
<div class="alert alert-warning mb-4">
    <i class="fa-solid fa-triangle-exclamation"></i>
    <span>No elective subjects are assigned to this class.</span>
</div>
<div class="modal-action border-t border-base-200 pt-4 mt-4">
    <form method="dialog">
        <button class="btn">Close</button>
    </form>
</div>

{% else %}
<form method="post"
      action="{% url 'core:bulk_assign_electives' class_obj.pk %}"
      hx-post="{% url 'core:bulk_assign_electives' class_obj.pk %}"
      hx-target="#modal-bulk-content"
      hx-swap="innerHTML">
    {% csrf_token %}

    <div class="alert alert-info mb-4">
        <i class="fa-solid fa-circle-info"></i>
        <div>
            <p class="font-medium">{{ students_needing_electives|length }} student{{ students_needing_electives|length|pluralize }} need{{ students_needing_electives|length|pluralize:"s," }} electives</p>
            <p class="text-sm">Each student should have {{ required_electives }} elective subject{{ required_electives|pluralize }}.</p>
        </div>
    </div>

    <!-- Select Electives -->
    <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold text-sm">Select electives to assign:</h4>
            <label class="flex items-center gap-2 text-xs cursor-pointer">
                <input type="checkbox" class="checkbox checkbox-xs"
                       onchange="document.querySelectorAll('.elective-cb').forEach(c => c.checked = this.checked)">
                Select all
            </label>
        </div>
        <div class="space-y-1 max-h-40 overflow-y-auto border border-base-200 rounded-lg p-2">
            {% for cs in elective_subjects %}
            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200/50 cursor-pointer">
                <input type="checkbox" name="electives" value="{{ cs.pk }}" class="checkbox checkbox-secondary checkbox-sm elective-cb">
                <span class="font-medium">{{ cs.subject.name }}</span>
                {% if cs.teacher %}
                <span class="text-xs text-base-content/50">({{ cs.teacher.full_name }})</span>
                {% endif %}
            </label>
            {% endfor %}
        </div>
    </div>

    <!-- Select Students -->
    <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold text-sm">Apply to students:</h4>
            <label class="flex items-center gap-2 text-xs cursor-pointer">
                <input type="checkbox" class="checkbox checkbox-xs" checked
                       onchange="document.querySelectorAll('.student-cb').forEach(c => c.checked = this.checked)">
                Select all
            </label>
        </div>
        <div class="space-y-1 max-h-40 overflow-y-auto border border-base-200 rounded-lg p-2">
            {% for item in students_needing_electives %}
            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200/50 cursor-pointer">
                <input type="checkbox" name="students" value="{{ item.student.pk }}" class="checkbox checkbox-sm student-cb" checked>
                <div class="flex-1 flex items-center justify-between">
                    <span>{{ item.student.full_name }}</span>
                    <span class="badge badge-warning badge-sm">{{ item.current_count }}/{{ required_electives }}</span>
                </div>
            </label>
            {% endfor %}
        </div>
    </div>

    <div class="modal-action border-t border-base-200 pt-4 mt-4">
        <form method="dialog">
            <button class="btn">Cancel</button>
        </form>
        <button type="submit" class="btn btn-secondary">
            <i class="fa-solid fa-check mr-1"></i>
            Assign Electives
        </button>
    </div>
</form>
{% endif %}
