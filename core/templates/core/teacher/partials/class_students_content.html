{% load core_tags %}

<!-- Page Header -->
<div class="flex items-center gap-2 sm:gap-3 mb-6">
    <a href="{% url 'core:my_classes' %}"
       hx-get="{% url 'core:my_classes' %}"
       hx-target="#main-content"
       hx-push-url="true"
       hx-swap="innerHTML show:window:top"
       class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center shrink-0"
       title="Back to Classes">
        <i class="fa-solid fa-arrow-left text-white text-sm sm:text-base"></i>
    </a>
    <div class="flex-1 min-w-0">
        <h1 class="text-base sm:text-xl font-bold">{{ class_obj.name }} Students</h1>
        <p class="text-[10px] sm:text-xs text-base-content/60">
            {% if current_term %}
            {{ current_term.name }} - {{ current_term.academic_year.name }}
            {% endif %}
        </p>
    </div>
    <div class="flex items-center gap-2">
        <span class="badge badge-sm sm:badge-lg gap-1 sm:gap-2">
            <i class="fa-solid fa-users"></i>
            {{ student_count }}
        </span>
        <button class="btn btn-primary btn-xs sm:btn-sm gap-1" onclick="document.getElementById('modal_enroll').showModal()">
            <i class="fa-solid fa-user-plus"></i>
            <span class="hidden sm:inline">Enroll</span>
        </button>
    </div>
</div>

<!-- Refreshable content area -->
<div id="students-list-container"
     hx-get="{% url 'core:class_students' class_obj.pk %}"
     hx-trigger="studentEnrolled from:body, studentRemoved from:body, electivesUpdated from:body"
     hx-select="#students-list-container"
     hx-swap="outerHTML">

{% if not students_data %}
<!-- No Students -->
<div class="card bg-base-100 shadow-sm border border-base-200">
    <div class="card-body py-12 text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-info/10 flex items-center justify-center">
            <i class="fa-solid fa-users-slash text-info text-2xl"></i>
        </div>
        <h3 class="font-semibold text-lg mb-2">No Students Yet</h3>
        <p class="text-base-content/60 max-w-md mx-auto mb-4">
            There are no students enrolled in {{ class_obj.name }}.
            Use the "Enroll Student" button to add students to this class.
        </p>
        <button class="btn btn-primary" onclick="document.getElementById('modal_enroll').showModal()">
            <i class="fa-solid fa-user-plus"></i>
            Enroll First Student
        </button>
    </div>
</div>

{% else %}

<!-- Subject Summary -->
{% if school.has_programmes %}
<!-- SHS: Core and Elective Subjects in two columns -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <!-- Core Subjects -->
    <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-4">
            <h3 class="font-semibold text-sm flex items-center gap-2 mb-3">
                <i class="fa-solid fa-book text-primary"></i>
                Core Subjects
                <span class="badge badge-primary badge-sm">{{ core_subjects|length }}</span>
            </h3>
            {% if core_subjects %}
            <div class="flex flex-wrap gap-2">
                {% for cs in core_subjects %}
                <span class="badge badge-outline badge-sm">{{ cs.subject.short_name|default:cs.subject.name }}</span>
                {% endfor %}
            </div>
            <p class="text-xs text-base-content/60 mt-2">
                <i class="fa-solid fa-circle-info mr-1"></i>
                All students are automatically enrolled in core subjects.
            </p>
            {% else %}
            <p class="text-sm text-base-content/60">No core subjects assigned to this class.</p>
            {% endif %}
        </div>
    </div>

    <!-- Elective Subjects -->
    <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-4">
            <h3 class="font-semibold text-sm flex items-center gap-2 mb-3">
                <i class="fa-solid fa-book-bookmark text-secondary"></i>
                Elective Subjects
                <span class="badge badge-secondary badge-sm">{{ elective_subjects|length }}</span>
                {% if required_electives %}
                <span class="text-xs text-base-content/60">({{ required_electives }} required)</span>
                {% endif %}
            </h3>
            {% if elective_subjects %}
            <div class="flex flex-wrap gap-2">
                {% for cs in elective_subjects %}
                <span class="badge badge-outline badge-sm">{{ cs.subject.short_name|default:cs.subject.name }}</span>
                {% endfor %}
            </div>
            <p class="text-xs text-base-content/60 mt-2">
                <i class="fa-solid fa-circle-info mr-1"></i>
                Click on a student to assign elective subjects.
            </p>
            {% else %}
            <p class="text-sm text-base-content/60">No elective subjects assigned to this class.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Warning if students are missing electives -->
{% if students_missing_electives > 0 %}
<div class="alert alert-warning mb-6">
    <i class="fa-solid fa-triangle-exclamation"></i>
    <div class="flex-1">
        <div class="font-medium">{{ students_missing_electives }} student{{ students_missing_electives|pluralize }} need{{ students_missing_electives|pluralize:"s," }} more electives</div>
        <div class="text-sm">Students should have {{ required_electives }} elective subject{{ required_electives|pluralize }} selected for grade calculation.</div>
    </div>
    <button class="btn btn-sm btn-warning"
            hx-get="{% url 'core:bulk_assign_electives' class_obj.pk %}"
            hx-target="#modal-bulk-content"
            onclick="document.getElementById('modal_bulk_electives').showModal()">
        <i class="fa-solid fa-users-gear"></i>
        Bulk Assign
    </button>
</div>
{% endif %}
{% else %}
<!-- Basic: All subjects in one card -->
<div class="card bg-base-100 shadow-sm border border-base-200 mb-6">
    <div class="card-body p-4">
        <h3 class="font-semibold text-sm flex items-center gap-2 mb-3">
            <i class="fa-solid fa-book text-primary"></i>
            Class Subjects
            <span class="badge badge-primary badge-sm">{{ core_subjects|length }}</span>
        </h3>
        {% if core_subjects %}
        <div class="flex flex-wrap gap-2">
            {% for cs in core_subjects %}
            <span class="badge badge-outline badge-sm">{{ cs.subject.short_name|default:cs.subject.name }}</span>
            {% endfor %}
        </div>
        <p class="text-xs text-base-content/60 mt-2">
            <i class="fa-solid fa-circle-info mr-1"></i>
            All students are enrolled in these subjects.
        </p>
        {% else %}
        <p class="text-sm text-base-content/60">No subjects assigned to this class yet.</p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Students Table -->
<div class="card bg-base-100 shadow-sm border border-base-200">
    <div class="card-body p-0">
        <div class="overflow-x-auto">
            <table class="table table-sm">
                <thead>
                    <tr class="bg-base-200">
                        <th class="min-w-[200px]">Student</th>
                        <th class="text-center">Admission No</th>
                        <th class="text-center">Gender</th>
                        <th class="text-center">Subjects</th>
                        {% if school.has_programmes %}<th class="min-w-[150px]">Electives</th>{% endif %}
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in students_data %}
                    <tr class="hover">
                        <td>
                            <div class="flex items-center gap-3">
                                <div class="avatar placeholder">
                                    <div class="w-10 h-10 rounded-full bg-base-300 text-base-content">
                                        {% if item.student.photo %}
                                        <img src="{{ item.student.photo.url }}" alt="{{ item.student.full_name }}" loading="lazy" />
                                        {% else %}
                                        <span class="text-sm">{{ item.student.first_name|slice:":1" }}{{ item.student.last_name|slice:":1" }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <div class="font-medium">{{ item.student.full_name }}</div>
                                    <div class="text-xs text-base-content/50">
                                        {% if item.student.date_of_birth %}
                                        Born: {{ item.student.date_of_birth|date:"M d, Y" }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center font-mono text-sm">{{ item.student.admission_number }}</td>
                        <td class="text-center">
                            {% if item.student.gender == 'M' %}
                            <span class="badge badge-info badge-sm">Male</span>
                            {% else %}
                            <span class="badge badge-secondary badge-sm">Female</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge badge-outline">{{ item.enrolled_subjects_count }}</span>
                        </td>
                        {% if school.has_programmes %}
                        <td>
                            {% if item.enrolled_electives %}
                            <div class="flex flex-wrap gap-1 items-center">
                                {% for subject in item.enrolled_electives %}
                                <span class="badge badge-sm badge-ghost">{{ subject.short_name }}</span>
                                {% endfor %}
                                {% if not item.electives_complete %}
                                <span class="badge badge-sm badge-warning gap-1" title="Needs {{ item.electives_missing }} more elective{{ item.electives_missing|pluralize }}">
                                    <i class="fa-solid fa-exclamation text-xs"></i>
                                    {{ item.elective_count }}/{{ required_electives }}
                                </span>
                                {% else %}
                                <span class="badge badge-sm badge-success gap-1">
                                    <i class="fa-solid fa-check text-xs"></i>
                                </span>
                                {% endif %}
                            </div>
                            {% elif elective_subjects %}
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-base-content/50">None selected</span>
                                {% if required_electives %}
                                <span class="badge badge-sm badge-warning gap-1">
                                    <i class="fa-solid fa-exclamation text-xs"></i>
                                    0/{{ required_electives }}
                                </span>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-xs text-base-content/50">-</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td class="text-center">
                            <div class="flex items-center justify-center gap-1">
                                {% if school.has_programmes and elective_subjects %}
                                <button class="btn btn-ghost btn-xs"
                                        onclick="openElectivesModal({{ item.student.pk }}, '{{ item.student.full_name }}')"
                                        title="Manage Electives">
                                    <i class="fa-solid fa-book-bookmark text-secondary"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-ghost btn-xs text-error"
                                        hx-post="{% url 'core:remove_student' class_obj.pk item.student.pk %}"
                                        hx-confirm="Are you sure you want to remove {{ item.student.full_name }} from this class?"
                                        title="Remove from class">
                                    <i class="fa-solid fa-user-minus"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endif %}
</div><!-- end students-list-container -->

<!-- Enroll Student Modal -->
<dialog id="modal_enroll" class="modal modal-middle">
    <div class="modal-box max-w-lg">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </form>
        <h3 class="text-lg font-bold mb-4">
            <i class="fa-solid fa-user-plus text-primary mr-2"></i>
            Enroll Student to {{ class_obj.name }}
        </h3>

        {% if available_students %}
        <form hx-post="{% url 'core:enroll_student' class_obj.pk %}"
              hx-swap="none"
              hx-on::after-request="if(event.detail.successful) document.getElementById('modal_enroll').close()">
            {% csrf_token %}

            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text font-medium">Select Student</span>
                </label>
                <select name="student_id" class="select select-bordered w-full" required>
                    <option value="">-- Choose a student --</option>
                    {% for student in available_students %}
                    <option value="{{ student.pk }}">
                        {{ student.full_name }} ({{ student.admission_number }})
                    </option>
                    {% endfor %}
                </select>
                <label class="label">
                    <span class="label-text-alt text-base-content/60">
                        Showing students not currently in any class
                    </span>
                </label>
            </div>

            <div class="alert alert-info mb-4">
                <i class="fa-solid fa-circle-info"></i>
                <div>
                    <p class="font-medium">What happens when you enroll:</p>
                    <ul class="list-disc list-inside text-sm mt-1">
                        <li>Student is added to {{ class_obj.name }}</li>
                        <li>Student is auto-enrolled in {{ core_subjects|length }} subject{{ core_subjects|length|pluralize }}</li>
                        {% if school.has_programmes and elective_subjects %}
                        <li>You can then assign elective subjects</li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('modal_enroll').close()">Cancel</button>
                <button type="submit" class="btn btn-primary gap-2">
                    <i class="fa-solid fa-user-plus"></i>
                    Enroll Student
                </button>
            </div>
        </form>
        {% else %}
        <div class="text-center py-8">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-warning/10 flex items-center justify-center">
                <i class="fa-solid fa-user-slash text-warning text-2xl"></i>
            </div>
            <h4 class="font-semibold mb-2">No Available Students</h4>
            <p class="text-base-content/60 text-sm mb-4">
                All active students are already assigned to classes.
                New students must be registered first before they can be enrolled.
            </p>
            <button type="button" class="btn btn-ghost" onclick="document.getElementById('modal_enroll').close()">Close</button>
        </div>
        {% endif %}
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{% if school.has_programmes %}
<!-- Electives Modal -->
<dialog id="modal_electives" class="modal modal-middle">
    <div class="modal-box max-w-md">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </form>
        <h3 class="text-lg font-bold mb-4">
            <i class="fa-solid fa-book-bookmark text-secondary mr-2"></i>
            Manage Electives
        </h3>

        <p class="text-sm text-base-content/60 mb-4" id="electives-student-name">
            Select elective subjects for student
        </p>

        <form id="electives-form"
              hx-post=""
              hx-swap="none"
              hx-on::after-request="if(event.detail.successful) document.getElementById('modal_electives').close()">
            {% csrf_token %}

            {% if elective_subjects %}
            <div class="space-y-2 mb-6">
                {% for cs in elective_subjects %}
                <label class="flex items-center gap-3 p-3 rounded-lg border border-base-200 hover:bg-base-200/50 cursor-pointer">
                    <input type="checkbox"
                           name="electives"
                           value="{{ cs.pk }}"
                           class="checkbox checkbox-secondary checkbox-sm elective-checkbox">
                    <div class="flex-1">
                        <div class="font-medium">{{ cs.subject.name }}</div>
                        {% if cs.teacher %}
                        <div class="text-xs text-base-content/50">
                            <i class="fa-solid fa-chalkboard-user mr-1"></i>
                            {{ cs.teacher.full_name }}
                        </div>
                        {% endif %}
                    </div>
                </label>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info mb-4">
                <i class="fa-solid fa-circle-info"></i>
                <span>No elective subjects available for this class.</span>
            </div>
            {% endif %}

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('modal_electives').close()">Cancel</button>
                <button type="submit" class="btn btn-secondary gap-2">
                    <i class="fa-solid fa-check"></i>
                    Save Electives
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Bulk Electives Modal -->
<dialog id="modal_bulk_electives" class="modal modal-middle">
    <div class="modal-box max-w-lg">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </form>
        <div id="modal-bulk-content">
            <div class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// Initialize student elective data (ClassSubject IDs)
window.studentElectives = {};
{% for item in students_data %}
window.studentElectives[{{ item.student.pk }}] = [{% for id in item.enrolled_elective_ids %}{{ id }}{% if not forloop.last %}, {% endif %}{% endfor %}];
{% endfor %}

// Listen for closeModal trigger to close dialogs
document.body.addEventListener('closeModal', function() {
    var el1 = document.getElementById('modal_bulk_electives'); if (el1) el1.close();
    var el2 = document.getElementById('modal_electives'); if (el2) el2.close();
});

function openElectivesModal(studentId, studentName) {
    document.getElementById('electives-student-name').textContent = 'Select elective subjects for ' + studentName;

    const form = document.getElementById('electives-form');
    form.setAttribute('hx-post', '{% url "core:update_student_electives" class_obj.pk 0 %}'.replace('/0/', '/' + studentId + '/'));
    htmx.process(form);

    // Reset all checkboxes
    document.querySelectorAll('.elective-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });

    // Check boxes for currently enrolled electives (using ClassSubject IDs)
    const enrolledIds = window.studentElectives[studentId] || [];
    enrolledIds.forEach(classSubjectId => {
        const checkbox = document.querySelector('.elective-checkbox[value="' + classSubjectId + '"]');
        if (checkbox) checkbox.checked = true;
    });

    document.getElementById('modal_electives').showModal();
}
</script>
{% endif %}
