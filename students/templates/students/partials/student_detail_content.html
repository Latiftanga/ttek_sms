{% load core_tags %}

<div class="print:max-w-none"
     x-data="{
        activeTab: new URLSearchParams(window.location.search).get('tab') || 'overview',
        setTab(tab) {
            this.activeTab = tab;
            const url = new URL(window.location);
            url.searchParams.set('tab', tab);
            window.history.replaceState({}, '', url);
        }
     }">

    <!-- Compact Header -->
    <div class="flex items-center gap-2 sm:gap-3 mb-4 print:!hidden">
        <a href="{% url 'students:index' %}"
           hx-get="{% url 'students:index' %}"
           hx-target="#main-content"
           hx-swap="innerHTML"
           hx-push-url="true"
           class="btn btn-ghost btn-sm btn-square shrink-0">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div class="flex-1 min-w-0">
            <h1 class="text-base sm:text-lg font-bold truncate">{{ student.full_name }}</h1>
            <p class="text-[10px] sm:text-xs text-base-content/60 flex items-center gap-1 sm:gap-2">
                <span class="font-mono">{{ student.admission_number }}</span>
                {% if student.current_class %}
                <span class="hidden sm:inline">•</span>
                <span class="hidden sm:inline">{{ student.current_class.name }}</span>
                {% endif %}
            </p>
        </div>
        <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-ghost btn-sm btn-square">
                <i class="fa-solid fa-ellipsis-vertical"></i>
            </label>
            <ul tabindex="0" class="dropdown-content menu menu-sm bg-base-100 rounded-box shadow-lg border border-base-200 w-44 z-50">
                <li>
                    <a href="{% url 'students:student_edit' student.pk %}"
                       hx-get="{% url 'students:student_edit' student.pk %}"
                       hx-target="#main-content"
                       hx-push-url="true">
                        <i class="fa-solid fa-pen"></i> Edit
                    </a>
                </li>
                <li>
                    <a href="{% url 'students:student_detail_pdf' student.pk %}">
                        <i class="fa-solid fa-file-pdf"></i> Download PDF
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Print Header -->
    <div class="hidden print:!block print:mb-6 print:border-b print:border-black print:pb-3">
        <div class="text-center">
            <h1 class="text-lg font-bold uppercase">Student Profile</h1>
            <h2 class="text-xl font-bold mt-2">{{ student.full_name }}</h2>
            <p class="text-sm">{{ student.admission_number }}</p>
        </div>
    </div>

    <!-- Profile Card -->
    <div class="card bg-base-100 shadow-sm border border-base-200 mb-4 print:shadow-none print:border-gray-300">
        <div class="card-body p-4">
            <div class="flex items-start gap-4">
                <!-- Avatar -->
                <div class="avatar shrink-0">
                    <div class="w-16 sm:w-20 rounded-full bg-base-200 ring-2 ring-primary ring-offset-base-100 ring-offset-2">
                        {% if student.photo %}
                        <img src="{{ student.photo.url }}" alt="{{ student.full_name }}" class="rounded-full object-cover" loading="lazy" />
                        {% else %}
                        <div class="w-full h-full flex items-center justify-center {{ student.gender|yesno:'bg-blue-100 text-blue-600,bg-pink-100 text-pink-600' }}">
                            <span class="text-xl sm:text-2xl font-bold">{{ student.first_name|slice:":1" }}{{ student.last_name|slice:":1" }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Info -->
                <div class="flex-1 min-w-0">
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                        {% if student.status == 'active' %}
                        <span class="badge badge-success badge-sm">Active</span>
                        {% elif student.status == 'graduated' %}
                        <span class="badge badge-info badge-sm">Graduated</span>
                        {% else %}
                        <span class="badge badge-ghost badge-sm">{{ student.get_status_display }}</span>
                        {% endif %}

                        {% if student.current_class %}
                        <span class="badge badge-primary badge-outline badge-sm">{{ student.current_class.name }}</span>
                        {% endif %}
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
                        <div>
                            <p class="text-[10px] uppercase text-base-content/50 font-medium">Age</p>
                            <p class="font-medium">{{ student.age }} yrs</p>
                        </div>
                        <div>
                            <p class="text-[10px] uppercase text-base-content/50 font-medium">Gender</p>
                            <p class="font-medium flex items-center gap-1">
                                <i class="fa-solid {{ student.gender|yesno:'fa-mars text-blue-500,fa-venus text-pink-500' }} text-xs"></i>
                                {{ student.get_gender_display }}
                            </p>
                        </div>
                        {% if tenant.has_houses and student.house %}
                        <div>
                            <p class="text-[10px] uppercase text-base-content/50 font-medium">House</p>
                            <p class="font-medium flex items-center gap-1">
                                {% if student.house.color_code %}
                                <span class="w-2 h-2 rounded-full" style="background-color: {{ student.house.color_code }};"></span>
                                {% endif %}
                                {{ student.house.name }}
                            </p>
                        </div>
                        {% endif %}
                        {% with primary_guardian=student.get_primary_guardian %}
                        {% if primary_guardian %}
                        <div>
                            <p class="text-[10px] uppercase text-base-content/50 font-medium">Guardian</p>
                            <p class="font-medium truncate">{{ primary_guardian.full_name }}</p>
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>

            <!-- Mobile Quick Actions -->
            {% with primary_guardian=student.get_primary_guardian %}
            {% if primary_guardian and primary_guardian.phone_number %}
            <div class="flex gap-2 mt-4 pt-3 border-t border-base-200 sm:hidden">
                <a href="tel:{{ primary_guardian.phone_number }}" class="btn btn-sm btn-outline flex-1 gap-1">
                    <i class="fa-solid fa-phone"></i> Call Guardian
                </a>
                <a href="sms:{{ primary_guardian.phone_number }}" class="btn btn-sm btn-primary flex-1 gap-1">
                    <i class="fa-solid fa-message"></i> Message
                </a>
            </div>
            {% endif %}
            {% endwith %}
        </div>
    </div>

    <!-- Tabbed Content -->
    <div class="card bg-base-100 shadow-sm border border-base-200 print:shadow-none print:border-gray-300">

        <!-- Tabs Header - Labels visible on all sizes -->
        <div class="border-b border-base-200 px-2 sm:px-4 pt-1 print:!hidden">
            <div class="flex overflow-x-auto scrollbar-none -mb-px">
                <button class="flex-1 sm:flex-none px-2 sm:px-5 py-3 text-xs sm:text-sm font-medium border-b-2 transition-colors whitespace-nowrap cursor-pointer"
                        :class="activeTab === 'overview' ? 'border-primary text-primary' : 'border-transparent text-base-content/60 hover:text-base-content'"
                        @click="setTab('overview')">
                    <i class="fa-regular fa-id-card mr-1"></i>
                    <span>Info</span>
                </button>
                <button class="flex-1 sm:flex-none px-2 sm:px-5 py-3 text-xs sm:text-sm font-medium border-b-2 transition-colors whitespace-nowrap cursor-pointer"
                        :class="activeTab === 'guardians' ? 'border-primary text-primary' : 'border-transparent text-base-content/60 hover:text-base-content'"
                        @click="setTab('guardians')">
                    <i class="fa-solid fa-user-shield mr-1"></i>
                    <span>Guardian</span>
                </button>
                <button class="flex-1 sm:flex-none px-2 sm:px-5 py-3 text-xs sm:text-sm font-medium border-b-2 transition-colors whitespace-nowrap cursor-pointer"
                        :class="activeTab === 'academics' ? 'border-primary text-primary' : 'border-transparent text-base-content/60 hover:text-base-content'"
                        @click="setTab('academics')">
                    <i class="fa-solid fa-graduation-cap mr-1"></i>
                    <span>Grades</span>
                </button>
                <button class="flex-1 sm:flex-none px-2 sm:px-5 py-3 text-xs sm:text-sm font-medium border-b-2 transition-colors whitespace-nowrap cursor-pointer"
                        :class="activeTab === 'system' ? 'border-primary text-primary' : 'border-transparent text-base-content/60 hover:text-base-content'"
                        @click="setTab('system')">
                    <i class="fa-solid fa-gear mr-1"></i>
                    <span>System</span>
                </button>
            </div>
        </div>

        <!-- Tab: Overview -->
        <div x-show="activeTab === 'overview'" x-cloak class="p-4 sm:p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Personal Info -->
                <div>
                    <h3 class="font-bold text-xs uppercase text-base-content/50 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-user text-primary"></i> Personal Information
                    </h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">First Name</p>
                                <p class="font-medium text-sm">{{ student.first_name }}</p>
                            </div>
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Last Name</p>
                                <p class="font-medium text-sm">{{ student.last_name }}</p>
                            </div>
                            {% if student.other_names %}
                            <div class="bg-base-200/50 rounded-lg p-3 col-span-2">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Other Names</p>
                                <p class="font-medium text-sm">{{ student.other_names }}</p>
                            </div>
                            {% endif %}
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Date of Birth</p>
                                <p class="font-medium text-sm">{{ student.date_of_birth|date:"M j, Y" }}</p>
                            </div>
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Gender</p>
                                <p class="font-medium text-sm">{{ student.get_gender_display }}</p>
                            </div>
                        </div>
                        {% if student.address %}
                        <div class="bg-base-200/50 rounded-lg p-3">
                            <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Address</p>
                            <p class="font-medium text-sm">{{ student.address }}</p>
                        </div>
                        {% endif %}
                        {% if student.phone %}
                        <div class="bg-base-200/50 rounded-lg p-3">
                            <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Phone</p>
                            <a href="tel:{{ student.phone }}" class="font-medium text-sm link link-hover">{{ student.phone }}</a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Admission Info -->
                <div>
                    <h3 class="font-bold text-xs uppercase text-base-content/50 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-list text-secondary"></i> Admission Information
                    </h3>
                    <div class="space-y-3">
                        <div class="bg-base-200/50 rounded-lg p-3">
                            <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Admission Number</p>
                            <p class="font-mono font-medium text-sm tracking-wide">{{ student.admission_number }}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Admission Date</p>
                                <p class="font-medium text-sm">{{ student.admission_date|date:"M j, Y" }}</p>
                            </div>
                            <div class="bg-base-200/50 rounded-lg p-3">
                                <p class="text-[10px] uppercase text-base-content/50 font-medium mb-0.5">Current Status</p>
                                <p class="font-medium text-sm">{{ student.get_status_display }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Guardians -->
        <div x-show="activeTab === 'guardians'" x-cloak class="p-4 sm:p-6" style="display: none;">
            {% if student_guardians %}
            <div class="space-y-3">
                {% for sg in student_guardians %}
                <div class="bg-base-200/30 border border-base-200 rounded-xl p-4">
                    <div class="flex items-start justify-between gap-3 mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary shrink-0">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm">{{ sg.guardian.full_name }}</h4>
                                <p class="text-xs text-base-content/60">{{ sg.get_relationship_display }}</p>
                            </div>
                        </div>
                        {% if sg.is_primary %}
                        <span class="badge badge-primary badge-sm shrink-0">Primary</span>
                        {% endif %}
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                        <a href="tel:{{ sg.guardian.phone_number }}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-base-200 transition-colors">
                            <i class="fa-solid fa-phone text-success w-4"></i>
                            <span>{{ sg.guardian.phone_number }}</span>
                        </a>
                        {% if sg.guardian.email %}
                        <a href="mailto:{{ sg.guardian.email }}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-base-200 transition-colors">
                            <i class="fa-solid fa-envelope text-info w-4"></i>
                            <span class="truncate">{{ sg.guardian.email }}</span>
                        </a>
                        {% endif %}
                        {% if sg.guardian.address %}
                        <div class="flex items-start gap-2 p-2 sm:col-span-2">
                            <i class="fa-solid fa-location-dot text-warning w-4 mt-0.5"></i>
                            <span>{{ sg.guardian.address }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-10">
                <div class="w-16 h-16 rounded-full bg-base-200 flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-user-shield text-2xl text-base-content/30"></i>
                </div>
                <h3 class="font-bold mb-1">No Guardians Linked</h3>
                <p class="text-sm text-base-content/60 mb-4">Add a guardian to this student's profile</p>
                <a href="{% url 'students:student_edit' student.pk %}"
                   hx-get="{% url 'students:student_edit' student.pk %}"
                   hx-target="#main-content"
                   hx-push-url="true"
                   class="btn btn-primary btn-sm">
                    <i class="fa-solid fa-plus"></i> Add Guardian
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Tab: Academics -->
        <div x-show="activeTab === 'academics'" x-cloak class="p-4 sm:p-6" style="display: none;">
            <h3 class="font-bold text-xs uppercase text-base-content/50 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-timeline text-primary"></i> Enrollment History
            </h3>

            {% if enrollments %}
            <div class="relative pl-4 border-l-2 border-primary/20 space-y-4">
                {% for enrollment in enrollments %}
                <div class="relative">
                    <!-- Timeline dot -->
                    <div class="absolute -left-[calc(1rem+5px)] w-2.5 h-2.5 rounded-full
                                {% if enrollment.status == 'active' %}bg-success{% else %}bg-primary{% endif %}"></div>

                    <div class="bg-base-200/50 rounded-lg p-3">
                        <div class="flex flex-wrap items-center justify-between gap-2 mb-1">
                            <span class="font-bold text-sm">{{ enrollment.class_assigned.name }}</span>
                            {% if enrollment.status == 'active' %}
                            <span class="badge badge-success badge-xs">Current</span>
                            {% elif enrollment.status == 'promoted' %}
                            <span class="badge badge-info badge-xs">Promoted</span>
                            {% elif enrollment.status == 'repeated' %}
                            <span class="badge badge-warning badge-xs">Repeated</span>
                            {% elif enrollment.status == 'graduated' %}
                            <span class="badge badge-primary badge-xs">Graduated</span>
                            {% else %}
                            <span class="badge badge-ghost badge-xs">{{ enrollment.get_status_display }}</span>
                            {% endif %}
                        </div>
                        <p class="text-xs text-base-content/60">
                            {{ enrollment.academic_year }} • Enrolled {{ enrollment.enrolled_on|date:"M Y" }}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-10">
                <div class="w-16 h-16 rounded-full bg-base-200 flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-graduation-cap text-2xl text-base-content/30"></i>
                </div>
                <p class="text-base-content/60">No enrollment history found</p>
            </div>
            {% endif %}
        </div>

        <!-- Tab: System -->
        <div x-show="activeTab === 'system'" x-cloak class="p-4 sm:p-6" style="display: none;">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Portal Access -->
                <div>
                    <h3 class="font-bold text-xs uppercase text-base-content/50 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-key text-primary"></i> Portal Access
                    </h3>
                    <div class="bg-base-200/50 rounded-xl p-4">
                        {% if student.user %}
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center text-success">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm">Account Linked</p>
                                <p class="text-xs text-base-content/60">
                                    {% if student.user.last_login %}
                                    Last login: {{ student.user.last_login|date:"M j, Y g:i A" }}
                                    {% else %}
                                    Never logged in
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% else %}
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-bold text-sm">No Account</p>
                                <p class="text-xs text-base-content/60">Student cannot access the portal</p>
                            </div>
                            <button class="btn btn-sm btn-primary"
                                    hx-get="{% url 'students:student_create_account' student.pk %}"
                                    hx-target="#create-account-container"
                                    onclick="modal_create_account.showModal()">
                                Create Account
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Danger Zone -->
                <div>
                    <h3 class="font-bold text-xs uppercase text-error/70 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-triangle-exclamation"></i> Danger Zone
                    </h3>
                    <div class="bg-error/5 border border-error/20 rounded-xl p-4">
                        <p class="font-bold text-sm text-error mb-1">Delete Student</p>
                        <p class="text-xs text-base-content/60 mb-3">This will permanently remove this student and all related records.</p>
                        <form hx-post="{% url 'students:student_delete' student.pk %}"
                              hx-confirm="Delete {{ student.full_name|escapejs }}? This action cannot be undone.">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-error btn-sm btn-outline w-full">
                                <i class="fa-solid fa-trash"></i> Delete Student
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Print Footer -->
    <div class="hidden print:!block print:mt-6 print:pt-3 print:border-t print:text-center print:text-xs">
        Printed on {% now "M j, Y g:i A" %}
    </div>
</div>

<!-- Create Account Modal -->
<dialog id="modal_create_account" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-lg">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </form>
        <div id="create-account-container">
            <div class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
