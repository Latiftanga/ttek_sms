{% load core_tags %}
<div class="print:max-w-none">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-6 print:!hidden">
        <div>
            {% if breadcrumbs %}
            <div class="mb-2">
                {% include "core/partials/breadcrumbs.html" with breadcrumbs=breadcrumbs only %}
            </div>
            {% endif %}
            <div class="flex items-center gap-3">
                <a href="{{ back_url|default:'/students/' }}"
                   hx-get="{{ back_url|default:'/students/' }}"
                   hx-target="#main-content"
                   hx-push-url="true"
                   class="btn btn-ghost btn-sm btn-circle"
                   title="Back to Students">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <div>
                    <h1 class="text-xl font-bold">{{ student.full_name }}</h1>
                    <p class="text-sm text-base-content/60 font-mono">{{ student.admission_number }}</p>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'students:student_detail_pdf' student.pk %}" class="btn btn-ghost btn-sm">
                <i class="fa-solid fa-file-pdf"></i>
                Download PDF
            </a>
            <a href="{% url 'students:student_edit' student.pk %}"
               hx-get="{% url 'students:student_edit' student.pk %}"
               hx-target="#main-content"
               hx-push-url="true"
               class="btn btn-primary btn-sm">
                <i class="fa-solid fa-pen"></i>
                Edit
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column: Photo & Quick Info -->
        <div class="lg:col-span-1 space-y-4">
            <!-- Photo & Status Card -->
            <div class="card bg-base-100 shadow-sm border border-base-200 print:shadow-none print:border-gray-300">
                <div class="card-body p-5 items-center text-center">
                    <div class="avatar mb-4">
                        <div class="w-36 h-36 rounded-full bg-base-200 flex items-center justify-center ring ring-primary ring-offset-base-100 ring-offset-2">
                            {% if student.photo %}
                            <img src="{{ student.photo.url }}" alt="{{ student.full_name }}" class="rounded-full object-cover" loading="lazy" />
                            {% else %}
                            <span class="text-4xl font-bold text-base-content/30">{{ student.first_name|slice:":1" }}{{ student.last_name|slice:":1" }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <h2 class="text-lg font-bold">{{ student.full_name }}</h2>
                    <p class="text-sm text-base-content/60 font-mono">{{ student.admission_number }}</p>

                    <!-- Status Badges -->
                    <div class="flex flex-wrap justify-center gap-2 mt-3 print:!hidden">
                        {% if student.current_class %}
                        <span class="badge badge-primary">{{ student.current_class.name }}</span>
                        {% endif %}
                        {% if tenant.has_houses and student.house %}
                        <span class="badge badge-outline" {% if student.house.color_code %}style="border-color: {{ student.house.color_code }}; color: {{ student.house.color_code }};"{% endif %}>
                            {{ student.house.name }}
                        </span>
                        {% endif %}
                        {% if student.gender == 'M' %}
                        <span class="badge badge-info">Male</span>
                        {% else %}
                        <span class="badge badge-secondary">Female</span>
                        {% endif %}
                        {% if student.status == 'active' %}
                        <span class="badge badge-success">Active</span>
                        {% elif student.status == 'graduated' %}
                        <span class="badge badge-info">Graduated</span>
                        {% elif student.status == 'withdrawn' %}
                        <span class="badge badge-warning">Withdrawn</span>
                        {% elif student.status == 'suspended' %}
                        <span class="badge badge-error">Suspended</span>
                        {% elif student.status == 'transferred' %}
                        <span class="badge badge-ghost">Transferred</span>
                        {% endif %}
                    </div>
                    <!-- Print status line -->
                    <p class="hidden print:!block text-sm mt-2">
                        {{ student.current_class.name|default:"No Class" }} | {{ student.get_gender_display }} | {{ student.get_status_display }}
                    </p>
                </div>
            </div>

            <!-- Quick Stats Card -->
            <div class="card bg-base-100 shadow-sm border border-base-200 print:shadow-none print:border-gray-300">
                <div class="card-body p-4">
                    <h3 class="font-semibold text-sm mb-3">Quick Info</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center">
                                <i class="fa-solid fa-cake-candles text-primary text-xs"></i>
                            </div>
                            <div>
                                <p class="text-base-content/60 text-xs">Age</p>
                                <p class="font-medium">{{ student.age }} years old</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-success/10 flex items-center justify-center">
                                <i class="fa-solid fa-calendar-check text-success text-xs"></i>
                            </div>
                            <div>
                                <p class="text-base-content/60 text-xs">Admitted</p>
                                <p class="font-medium">{{ student.admission_date|date:"M j, Y" }}</p>
                            </div>
                        </div>
                        {% if student.phone %}
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-info/10 flex items-center justify-center">
                                <i class="fa-solid fa-phone text-info text-xs"></i>
                            </div>
                            <div>
                                <p class="text-base-content/60 text-xs">Phone</p>
                                <p class="font-medium">{{ student.phone }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- System Info Card -->
            <div class="card bg-base-100 shadow-sm border border-base-200 print:!hidden">
                <div class="card-body p-4">
                    <h3 class="font-semibold text-sm mb-3">System</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-base-content/60">Account</span>
                            {% if student.user %}
                            <span class="badge badge-success badge-sm">Linked</span>
                            {% else %}
                            <button class="btn btn-xs btn-primary"
                                    hx-get="{% url 'students:student_create_account' student.pk %}"
                                    hx-target="#create-account-container"
                                    onclick="modal_create_account.showModal()">
                                <i class="fa-solid fa-user-plus"></i>
                                Create
                            </button>
                            {% endif %}
                        </div>
                        <div class="flex justify-between">
                            <span class="text-base-content/60">Active</span>
                            {% if student.is_active %}
                            <span class="badge badge-success badge-sm">Yes</span>
                            {% else %}
                            <span class="badge badge-error badge-sm">No</span>
                            {% endif %}
                        </div>
                        <div class="flex justify-between text-xs text-base-content/50">
                            <span>Created</span>
                            <span>{{ student.created_at|date:"M j, Y" }}</span>
                        </div>
                        <div class="flex justify-between text-xs text-base-content/50">
                            <span>Updated</span>
                            <span>{{ student.updated_at|date:"M j, Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card bg-error/5 border border-error/20 print:!hidden">
                <div class="card-body p-4">
                    <h3 class="font-semibold text-sm text-error mb-2">Danger Zone</h3>
                    <p class="text-xs text-base-content/60 mb-3">Permanently delete this student record.</p>
                    <form hx-post="{% url 'students:student_delete' student.pk %}"
                          hx-confirm="Delete {{ student.full_name }}? This action cannot be undone.">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-error btn-sm btn-outline w-full">
                            <i class="fa-solid fa-trash"></i>
                            Delete Student
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Details -->
        <div class="lg:col-span-2 space-y-4">

            <!-- Personal Information -->
            <div class="card bg-base-100 shadow-sm border border-base-200 print:shadow-none print:border-gray-300">
                <div class="card-body p-5">
                    <h2 class="font-semibold text-base flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-user text-primary print:!hidden"></i>
                        Personal Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">Full Name</p>
                            <p class="font-medium">{{ student.full_name }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">Date of Birth</p>
                            <p>{{ student.date_of_birth|date:"F j, Y" }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">Gender</p>
                            <p>{{ student.get_gender_display }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">Age</p>
                            <p>{{ student.age }} years</p>
                        </div>
                        {% if student.phone %}
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">Phone</p>
                            <p>{{ student.phone }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% if student.address %}
                    <div class="mt-4 pt-4 border-t border-base-200">
                        <p class="text-xs text-base-content/60 mb-1">Address</p>
                        <p>{{ student.address }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Guardians Information -->
            {% if student_guardians %}
            <div class="card bg-base-100 shadow-sm border border-base-200 print:shadow-none print:border-gray-300">
                <div class="card-body p-5">
                    <h2 class="font-semibold text-base flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-user-shield text-primary print:!hidden"></i>
                        Guardians ({{ student_guardians|length }})
                    </h2>
                    <div class="space-y-4">
                        {% for sg in student_guardians %}
                        <div class="{% if not forloop.last %}border-b border-base-200 pb-4{% endif %}">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium">{{ sg.guardian.full_name }}</span>
                                    {% if sg.is_primary %}
                                    <span class="badge badge-primary badge-sm">Primary</span>
                                    {% endif %}
                                </div>
                                <span class="text-sm text-base-content/60">{{ sg.get_relationship_display }}</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-sm">
                                <div>
                                    <span class="text-base-content/60">Phone:</span>
                                    <span>{{ sg.guardian.phone_number }}</span>
                                </div>
                                {% if sg.guardian.email %}
                                <div>
                                    <span class="text-base-content/60">Email:</span>
                                    <span>{{ sg.guardian.email }}</span>
                                </div>
                                {% endif %}
                                {% if sg.guardian.occupation %}
                                <div>
                                    <span class="text-base-content/60">Occupation:</span>
                                    <span>{{ sg.guardian.occupation }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% if sg.guardian.address %}
                            <div class="mt-2 text-sm">
                                <span class="text-base-content/60">Address:</span>
                                <span>{{ sg.guardian.address }}</span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Admission Details -->
            <div class="card bg-base-100 shadow-sm border border-base-200 print:shadow-none print:border-gray-300">
                <div class="card-body p-5">
                    <h2 class="font-semibold text-base flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-id-card text-primary print:!hidden"></i>
                        Admission Details
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">Admission Number</p>
                            <p class="font-mono font-medium">{{ student.admission_number }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">Admission Date</p>
                            <p>{{ student.admission_date|date:"F j, Y" }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">Current Class</p>
                            <p>{{ student.current_class.name|default:"Not Assigned" }}</p>
                        </div>
                        {% if tenant.has_houses %}
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">House</p>
                            {% if student.house %}
                            <p class="flex items-center gap-2">
                                {% if student.house.color_code %}
                                <span class="w-3 h-3 rounded-full" style="background-color: {{ student.house.color_code }};"></span>
                                {% endif %}
                                {{ student.house.name }}
                            </p>
                            {% else %}
                            <p class="text-base-content/50">Not Assigned</p>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div>
                            <p class="text-xs text-base-content/60 mb-1">Status</p>
                            <p>{{ student.get_status_display }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enrollment History -->
            {% if enrollments %}
            <div class="card bg-base-100 shadow-sm border border-base-200 print:shadow-none print:border-gray-300">
                <div class="card-body p-5">
                    <h2 class="font-semibold text-base flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-timeline text-primary print:!hidden"></i>
                        Enrollment History
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="table table-sm">
                            <thead>
                                <tr class="text-xs">
                                    <th>Academic Year</th>
                                    <th>Class</th>
                                    <th>Status</th>
                                    <th>Enrolled On</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enrollment in enrollments %}
                                <tr>
                                    <td class="font-medium">{{ enrollment.academic_year }}</td>
                                    <td>
                                        <span class="badge badge-sm">{{ enrollment.class_assigned.name }}</span>
                                    </td>
                                    <td>
                                        {% if enrollment.status == 'active' %}
                                        <span class="badge badge-success badge-sm">Active</span>
                                        {% elif enrollment.status == 'promoted' %}
                                        <span class="badge badge-info badge-sm">Promoted</span>
                                        {% elif enrollment.status == 'repeated' %}
                                        <span class="badge badge-warning badge-sm">Repeated</span>
                                        {% elif enrollment.status == 'graduated' %}
                                        <span class="badge badge-primary badge-sm">Graduated</span>
                                        {% else %}
                                        <span class="badge badge-ghost badge-sm">{{ enrollment.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-xs text-base-content/60">{{ enrollment.enrolled_on|date:"M j, Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<!-- Create Account Modal -->
<dialog id="modal_create_account" class="modal modal-middle">
    <div class="modal-box max-w-lg">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </form>
        <div id="create-account-container">
            <div class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
