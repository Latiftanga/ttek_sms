{% load core_tags %}
<div class="space-y-4">
    <!-- Page Header -->
    <div class="flex items-center justify-between gap-2">
        <div>
            {% if breadcrumbs %}
            <div class="mb-2">
                {% include "core/partials/breadcrumbs.html" with breadcrumbs=breadcrumbs only %}
            </div>
            {% endif %}
            <h1 class="text-xl font-bold flex items-center gap-2">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                    <i class="fa-solid fa-ticket text-white"></i>
                </div>
                Exeats
            </h1>
            <p class="text-sm text-base-content/60 ml-12">
                {% if assignment %}{{ assignment.house.name }}{% else %}All Houses{% endif %}
            </p>
        </div>
        <div class="flex gap-2">
            {% if is_senior %}
            <a href="{% url 'students:exeat_report' %}"
               hx-get="{% url 'students:exeat_report' %}"
               hx-target="#main-content"
               hx-push-url="true"
               class="btn btn-ghost btn-sm"
               title="View Reports">
                <i class="fa-solid fa-chart-bar"></i>
                <span class="hidden sm:inline">Reports</span>
            </a>
            {% endif %}
            <a href="{% url 'students:exeat_create' %}"
               hx-get="{% url 'students:exeat_create' %}"
               hx-target="#main-content"
               hx-push-url="true"
               class="btn btn-primary btn-sm">
                <i class="fa-solid fa-plus"></i>
                <span class="hidden sm:inline">New Request</span>
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="flex flex-wrap gap-2">
        <div class="card bg-warning/10 border border-warning/20 flex-1 min-w-[80px]">
            <div class="card-body p-2 text-center">
                <div class="text-lg font-bold text-warning">{{ stats.pending }}</div>
                <div class="text-xs text-warning/80">Pending</div>
            </div>
        </div>
        <div class="card bg-info/10 border border-info/20 flex-1 min-w-[80px]">
            <div class="card-body p-2 text-center">
                <div class="text-lg font-bold text-info">{{ stats.recommended }}</div>
                <div class="text-xs text-info/80">Recommended</div>
            </div>
        </div>
        <div class="card bg-success/10 border border-success/20 flex-1 min-w-[80px]">
            <div class="card-body p-2 text-center">
                <div class="text-lg font-bold text-success">{{ stats.active }}</div>
                <div class="text-xs text-success/80">Active</div>
            </div>
        </div>
        <div class="card bg-primary/10 border border-primary/20 flex-1 min-w-[80px]">
            <div class="card-body p-2 text-center">
                <div class="text-lg font-bold text-primary">{{ stats.today_departures }}</div>
                <div class="text-xs text-primary/80">Today</div>
            </div>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-3">
            <form id="exeat-filter-form"
                  hx-get="{% url 'students:exeat_index' %}"
                  hx-target="#exeat-results"
                  hx-select="#exeat-results"
                  hx-swap="outerHTML"
                  hx-trigger="submit, change from:select"
                  class="flex flex-col sm:flex-row gap-2">
                <div class="flex gap-2 flex-1">
                    <div class="flex-1 min-w-0 relative">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-base-content/40 text-sm"></i>
                        <input type="text"
                               name="search"
                               value="{{ search }}"
                               placeholder="Search student or destination..."
                               class="input input-sm input-bordered w-full pl-9"
                               hx-get="{% url 'students:exeat_index' %}"
                               hx-target="#exeat-results"
                               hx-select="#exeat-results"
                               hx-swap="outerHTML"
                               hx-trigger="keyup changed delay:300ms"
                               hx-include="closest form" />
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    {% if is_senior and houses %}
                    <select name="house" class="select select-sm select-bordered flex-1 sm:flex-none sm:w-auto">
                        <option value="">All Houses</option>
                        {% for house in houses %}
                        <option value="{{ house.pk }}" {% if house_filter == house.pk|stringformat:"s" %}selected{% endif %}>{{ house.name }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                    <select name="status" class="select select-sm select-bordered flex-1 sm:flex-none sm:w-auto">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="type" class="select select-sm select-bordered flex-1 sm:flex-none sm:w-auto">
                        <option value="">All Types</option>
                        {% for value, label in type_choices %}
                        <option value="{{ value }}" {% if type_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    {% if search or status_filter or type_filter or house_filter %}
                    <a href="{% url 'students:exeat_index' %}"
                       hx-get="{% url 'students:exeat_index' %}"
                       hx-target="#main-content"
                       hx-push-url="true"
                       class="btn btn-sm btn-ghost text-error">
                        <i class="fa-solid fa-times"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Exeats List -->
    <div id="exeat-results">
    {% if exeats %}
    <div class="space-y-2">
        {% for exeat in exeats %}
        <a href="{% url 'students:exeat_detail' exeat.pk %}"
           hx-get="{% url 'students:exeat_detail' exeat.pk %}"
           hx-target="#main-content"
           hx-push-url="true"
           class="card bg-base-100 shadow-sm border border-base-200 hover:border-primary/30 transition-colors block">
            <div class="card-body p-3">
                <div class="flex items-center gap-3">
                    <!-- Avatar -->
                    <div class="avatar placeholder flex-shrink-0">
                        <div class="w-10 h-10 rounded-full bg-base-300 text-base-content flex items-center justify-center">
                            {% if exeat.student.photo %}
                            <img src="{{ exeat.student.photo.url }}" alt="" class="rounded-full" loading="lazy" />
                            {% else %}
                            <span class="text-sm font-medium">{{ exeat.student.first_name|slice:":1" }}{{ exeat.student.last_name|slice:":1" }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                            <h3 class="font-semibold text-sm truncate">{{ exeat.student.full_name }}</h3>
                            {% if exeat.exeat_type == 'internal' %}
                            <span class="badge badge-ghost badge-xs">Internal</span>
                            {% else %}
                            <span class="badge badge-primary badge-xs">External</span>
                            {% endif %}
                            {% if exeat.status == 'pending' %}
                            <span class="badge badge-warning badge-xs">Pending</span>
                            {% elif exeat.status == 'recommended' %}
                            <span class="badge badge-info badge-xs">Recommended</span>
                            {% elif exeat.status == 'approved' %}
                            <span class="badge badge-success badge-xs">Approved</span>
                            {% elif exeat.status == 'active' %}
                            <span class="badge badge-accent badge-xs">Active</span>
                            {% elif exeat.status == 'completed' %}
                            <span class="badge badge-ghost badge-xs">Completed</span>
                            {% elif exeat.status == 'rejected' %}
                            <span class="badge badge-error badge-xs">Rejected</span>
                            {% elif exeat.status == 'overdue' %}
                            <span class="badge badge-error badge-xs animate-pulse">Overdue</span>
                            {% endif %}
                        </div>
                        <div class="flex flex-wrap gap-x-3 text-xs text-base-content/60">
                            <span><i class="fa-solid fa-location-dot mr-1"></i>{{ exeat.destination|truncatechars:20 }}</span>
                            <span><i class="fa-solid fa-calendar mr-1"></i>{{ exeat.departure_date|date:"M j" }}</span>
                            {% if exeat.student.house %}
                            <span class="hidden sm:inline">{{ exeat.student.house.name }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Arrow -->
                    <div class="flex-shrink-0 text-base-content/30">
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body">
            <div class="text-center py-8 text-base-content/40">
                <i class="fa-solid fa-ticket text-4xl mb-3"></i>
                <p class="text-sm">No exeats found</p>
                {% if search or status_filter or type_filter %}
                <p class="text-xs">Try adjusting your search or filters</p>
                {% else %}
                <p class="text-xs">Create a new exeat request to get started</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    </div>
</div>
